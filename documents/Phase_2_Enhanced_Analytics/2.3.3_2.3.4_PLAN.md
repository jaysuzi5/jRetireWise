# Phase 2.3.3 & 2.3.4 Implementation Plan
## Sensitivity Analysis & Tax-Aware Calculations

**Status**: Planning
**Phase**: 2 (Advanced Analytics)
**Estimated Duration**: 4-6 weeks
**Priority**: Medium-High

---

## Executive Summary

This plan covers two interconnected features for Phase 2:

1. **2.3.3 Sensitivity Analysis** - Interactive what-if modeling allowing users to adjust market returns, spending, and inflation to visualize portfolio impact on an existing scenario
2. **2.3.4 Tax-Aware Calculations** - Basic income tax estimation and optimized withdrawal sequencing (Roth vs Traditional accounts) for existing scenarios

**Important Architecture Note**: Both features are **ENHANCEMENTS to existing scenarios**, not new scenario calculator types. Users create a scenario using existing calculators (4%, Monte Carlo, etc.), then use these tools to analyze and optimize that scenario.

---

## 1. Feature 2.3.3: Sensitivity Analysis

### Overview

Sensitivity Analysis is an **analytical enhancement** to existing scenarios. It enables users to ask "what-if" questions about their retirement plan by testing how their existing scenario performs under different parameter variations:
- "What if returns are 2% lower?"
- "What if I need to spend 20% more?"
- "What if inflation averages 4% instead of 3%?"

Users select an existing scenario (created with 4% rule, Monte Carlo, etc.), adjust parameters interactively, and see real-time impact on retirement success metrics compared to the baseline scenario.

### Architectural Approach

**NOT a new scenario type** - Instead:
- Operates on existing `RetirementScenario` and its `CalculationResult`
- Creates `SensitivityAnalysis` records linked to the scenario
- Shows as a tab/panel on the scenario detail page
- Allows comparing parameterized variations against the baseline without creating new scenarios

### Requirements

**Key Principle**: Sensitivity Analysis operates on existing scenarios, not replacing them.

#### Functional Requirements

1. **Scenario Selection**
   - Users select an existing scenario to analyze
   - Sensitivity analysis operates on that scenario's baseline results
   - No new scenario is created

2. **Parameter Adjustment Interface**
   - Sliders for return rate (-5% to +5% from baseline)
   - Sliders for spending (+0% to +50% increase)
   - Sliders for inflation (+0% to +4% from baseline)
   - Reset to baseline button
   - Preset scenarios (Conservative, Moderate, Aggressive)

2. **Impact Visualization**
   - Side-by-side comparison with baseline scenario
   - "Sensitivity tornado" chart showing which parameters have most impact
   - Year-by-year portfolio balance comparison
   - Success rate meter (green/yellow/red zones)
   - Final portfolio value delta

3. **Result Metrics**
   - Success rate percentage (vs baseline)
   - Final portfolio value (vs baseline)
   - Years until depletion (if failure)
   - Withdrawal sustainability index
   - Parametric confidence intervals

4. **Scenario Management**
   - Save sensitivity scenarios for comparison
   - Compare up to 3 sensitivity scenarios side-by-side
   - Export sensitivity analysis results
   - View sensitivity history

#### Technical Requirements

1. **Backend**
   - New `SensitivityAnalyzer` calculator class
   - Parameter validation (ranges, logical constraints)
   - Batch calculation for multiple parameter combinations
   - Caching of calculated results

2. **Frontend**
   - Interactive sliders with real-time updates
   - Responsive charts (tornado diagram, comparison charts)
   - Live success rate indicator
   - Parameter delta display

3. **Database**
   - `SensitivityScenario` model to store saved analyses
   - `SensitivityParameter` model for parameter combinations

### Data Models

#### New Models

**Architecture Note**: These models are linked to existing RetirementScenario (not independent), allowing multiple analyses on the same scenario.

```python
class SensitivityAnalysis(models.Model):
    """Stores a saved sensitivity analysis for an existing scenario"""
    scenario = ForeignKey(RetirementScenario, on_delete=models.CASCADE)
    name = CharField(max_length=255)
    description = TextField(blank=True)

    # Baseline values (for comparison display)
    baseline_return_adjustment = FloatField(default=0.0)
    baseline_spending_adjustment = FloatField(default=0.0)
    baseline_inflation_adjustment = FloatField(default=0.0)

    # Sensitivity parameters tested
    return_range_min = FloatField()  # e.g., -0.05
    return_range_max = FloatField()  # e.g., +0.05
    return_step = FloatField()

    spending_range_min = FloatField()  # e.g., 0.0
    spending_range_max = FloatField()  # e.g., 0.50
    spending_step = FloatField()

    inflation_range_min = FloatField()  # e.g., 0.0
    inflation_range_max = FloatField()  # e.g., 0.04
    inflation_step = FloatField()

    # Results
    result_data = JSONField()  # Tornado chart data, success rates, etc.
    created_at = DateTimeField(auto_now_add=True)
    updated_at = DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']
```

### Implementation Approach

#### Phase 1: Backend Calculation Engine

1. **Create `SensitivityAnalyzer` Class**
   - Extend existing calculator classes
   - Accept parameter ranges (min, max, step)
   - Run multiple calculations across parameter combinations
   - Aggregate results for visualization

2. **Calculation Strategy**
   ```
   For each return adjustment (-5%, -4%, ... +5%):
     For each spending adjustment (0%, 10%, ... 50%):
       For each inflation adjustment (0%, 1%, ... 4%):
         Run calculator with adjusted parameters
         Store: success_rate, final_value, years_to_depletion
   ```

3. **Tornado Chart Data**
   - Calculate impact of varying one parameter at a time
   - Rank parameters by impact on success rate
   - Include confidence ranges

#### Phase 2: Frontend Interface

1. **Sensitivity Analysis Page** (`/scenarios/<pk>/sensitivity/`)
   - Parameter adjustment sliders
   - Real-time calculation feedback
   - Tornado chart visualization
   - Success rate meter
   - Preset scenario buttons

2. **Interactive Features**
   - Slider input with labels showing current value
   - Live calculation (debounced to avoid excessive recalculation)
   - Quick-click preset buttons (Conservative, Moderate, Aggressive)
   - Reset button

3. **Visualization Components**
   - Tornado chart (bar chart ranking parameters by impact)
   - Line chart comparing baseline vs adjusted portfolio values
   - Success rate gauge (0-100%)
   - Delta indicators (+/- compared to baseline)

#### Phase 3: Results & Comparison

1. **Results Display**
   - Key metrics dashboard
   - Sensitivity results table
   - Export to CSV/PDF

2. **Scenario Comparison**
   - Save multiple sensitivity scenarios
   - Compare up to 3 scenarios side-by-side
   - Highlight differences

### API Design

#### Endpoints

```
POST /api/scenarios/<pk>/sensitivity/calculate/
  Input: {
    return_adjustment: float,
    spending_adjustment: float,
    inflation_adjustment: float
  }
  Output: {
    success_rate: float,
    final_value: float,
    years_to_depletion: int|null,
    comparison_to_baseline: {
      return_adjustment_delta: float,
      success_rate_change: float
    }
  }

POST /api/scenarios/<pk>/sensitivity/tornado/
  Input: {
    return_range: [min, max, step],
    spending_range: [min, max, step],
    inflation_range: [min, max, step]
  }
  Output: {
    tornado_data: [...],
    parameter_impacts: [...]
  }

POST /api/scenarios/<pk>/sensitivity/save/
  Input: {
    name: string,
    description: string,
    parameters: {...},
    results: {...}
  }
  Output: { sensitivity_scenario_id: int }

GET /api/scenarios/<pk>/sensitivity/scenarios/
  Output: [{ id, name, description, created_at }, ...]

GET /api/scenarios/<pk>/sensitivity/<sensitivity_id>/
  Output: { full sensitivity scenario data }
```

### UI/UX Design

#### Sensitivity Analysis Page Layout

```
┌─────────────────────────────────────────────┐
│ Scenario: [Name] > Sensitivity Analysis    │
├─────────────────────────────────────────────┤
│                                              │
│  PARAMETER ADJUSTMENTS              RESULTS │
│  ┌──────────────────────┐        ┌────────┐ │
│  │ Return Rate:         │        │Success │ │
│  │ [-5%] ◉ [+5%]      │        │Rate:   │ │
│  │                      │        │ 92% ▓▓▓ │ │
│  │ Spending:            │        │ (Δ +2%) │ │
│  │ [0%] ◉ [+50%]      │        │        │ │
│  │                      │        │Final   │ │
│  │ Inflation:           │        │Value:  │ │
│  │ [0%] ◉ [+4%]       │        │$2.1M   │ │
│  │                      │        │(Δ -$50K)│ │
│  │ [Reset] [Save]       │        └────────┘ │
│  │                      │                    │
│  │ Quick Presets:       │                    │
│  │ [Conservative]       │                    │
│  │ [Moderate]           │                    │
│  │ [Aggressive]         │                    │
│  └──────────────────────┘                    │
│                                              │
│  TORNADO CHART                               │
│  ┌─────────────────────────────────────┐   │
│  │ Spending         ■■■■■■■■■ (2.1%)  │   │
│  │ Inflation        ■■■■■ (1.3%)       │   │
│  │ Returns          ■■■ (0.8%)         │   │
│  └─────────────────────────────────────┘   │
│                                              │
│  PORTFOLIO VALUE COMPARISON                  │
│  ┌─────────────────────────────────────┐   │
│  │ [Line chart: Baseline vs Adjusted]  │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

### Testing Strategy

#### Unit Tests

```python
# tests/unit/calculations/test_sensitivity_analyzer.py
- test_single_parameter_adjustment (return, spending, inflation)
- test_multiple_parameter_adjustment
- test_parameter_validation (bounds checking)
- test_tornado_chart_data_generation
- test_impact_ranking
- test_comparison_to_baseline
```

#### Integration Tests

```python
# tests/integration/test_sensitivity_views.py
- test_sensitivity_calculate_endpoint
- test_sensitivity_tornado_endpoint
- test_sensitivity_save_endpoint
- test_sensitivity_list_endpoint
- test_sensitivity_detail_endpoint
- test_sensitivity_access_control (user can only access own scenarios)
```

#### E2E Tests

```python
# tests/e2e/test_sensitivity_flow.py
- test_load_sensitivity_page
- test_adjust_parameters_and_see_results
- test_tornado_chart_renders
- test_save_sensitivity_scenario
- test_compare_scenarios
```

### Success Criteria

- [ ] Sensitivity analysis calculator runs in <5 seconds for standard parameters
- [ ] Tornado chart clearly shows parameter impact ranking
- [ ] Users can save/compare multiple sensitivity scenarios
- [ ] 100% unit test coverage for calculator
- [ ] 80%+ integration test coverage
- [ ] Real-time feedback as parameters are adjusted
- [ ] Responsive design works on mobile (sliders still usable)

---

## Phase 0: Social Security Profile Enhancement (Pre-Phase to 2.3.4)

**Purpose**: Foundation for tax-aware calculations by capturing Social Security benefits at different claiming ages, allowing calculators to use age-specific benefit amounts.

**Status**: Pre-phase requirement
**Dependencies**: Required before Feature 2.3.4
**Estimated Duration**: 1-2 weeks
**Priority**: Critical (blocking feature)

### Overview

Social Security benefits vary significantly based on claiming age. The Current State security benefit at age 62 (~70% of Full Retirement Age benefit), 65 (~86%), 67 (~100%), and 70 (~124%).

This phase:
1. **Enhances TaxProfile** to store Social Security benefits for multiple claiming ages
2. **Updates Financial Profile** form to allow entering benefits at each age
3. **Modifies all calculators** to use age-specific Social Security amounts
4. **Adds scenario parameter** for user to select claiming age (defaults to 67)

### Data Model Changes

#### Enhanced TaxProfile Model

```python
class TaxProfile(models.Model):
    """User's tax information for tax-aware calculations"""
    user = OneToOneField(User, on_delete=models.CASCADE)

    # ... existing fields ...

    # Social Security Benefits by Claiming Age
    # NEW: Store benefits for each possible claiming age
    social_security_age_62 = DecimalField(
        max_digits=12, decimal_places=2, default=0,
        help_text="Monthly benefit if claiming at age 62"
    )
    social_security_age_65 = DecimalField(
        max_digits=12, decimal_places=2, default=0,
        help_text="Monthly benefit if claiming at age 65"
    )
    social_security_age_67 = DecimalField(
        max_digits=12, decimal_places=2, default=0,
        help_text="Monthly benefit if claiming at age 67 (Full Retirement Age)"
    )
    social_security_age_70 = DecimalField(
        max_digits=12, decimal_places=2, default=0,
        help_text="Monthly benefit if claiming at age 70"
    )

    # KEEP: Reference to full retirement age for context
    full_retirement_age = IntegerField(default=67)

    # DEPRECATED: Replace with age-based lookup
    # social_security_annual = DecimalField(...)  # TO BE REMOVED

    created_at = DateTimeField(auto_now_add=True)
    updated_at = DateTimeField(auto_now=True)

    def get_social_security_annual(self, claiming_age: int) -> Decimal:
        """
        Get annual Social Security benefit for a specific claiming age.

        Args:
            claiming_age: Age at which user will claim Social Security (62, 65, 67, or 70)

        Returns:
            Annual Social Security benefit amount (monthly benefit * 12)

        Raises:
            ValueError: If claiming age is not one of the supported ages
        """
        age_benefit_map = {
            62: self.social_security_age_62,
            65: self.social_security_age_65,
            67: self.social_security_age_67,
            70: self.social_security_age_70,
        }

        if claiming_age not in age_benefit_map:
            raise ValueError(f"Claiming age must be 62, 65, 67, or 70, got {claiming_age}")

        monthly_benefit = age_benefit_map[claiming_age]
        return monthly_benefit * 12
```

#### RetirementScenario Model Enhancement

```python
class RetirementScenario(models.Model):
    """EXISTING MODEL - ADD FIELD"""
    # ... existing fields ...

    # NEW: Social Security claiming age parameter
    social_security_claiming_age = IntegerField(
        default=67,
        choices=[(62, '62'), (65, '65'), (67, '67 (Full Retirement)'), (70, '70')],
        help_text="Age at which user will claim Social Security"
    )

    # Note: This should be stored in the parameters JSONField as well for consistency
    # parameters = JSONField(default=dict)  # Should include social_security_claiming_age
```

### User Interface Changes

#### 1. Financial Profile Form Enhancement

Update the Financial Profile page (`/financial/profile/`) to show Social Security entry by age:

```
┌─────────────────────────────────────────────────────┐
│ Financial Profile > Social Security Information     │
├─────────────────────────────────────────────────────┤
│                                                      │
│ SOCIAL SECURITY BENEFIT ESTIMATES                   │
│ (Enter your estimated monthly benefit for each      │
│  claiming age. If unsure, visit ssa.gov)            │
│                                                      │
│ ┌───────────────────────────────────────────────┐   │
│ │ Claiming at Age 62:                           │   │
│ │ Monthly Benefit: $[2,500]  Annual: $30,000   │   │
│ │ (Reduced benefit - ~70% of Full Retirement)  │   │
│ │                                               │   │
│ │ Claiming at Age 65:                           │   │
│ │ Monthly Benefit: $[3,200]  Annual: $38,400   │   │
│ │ (~86% of Full Retirement Age amount)         │   │
│ │                                               │   │
│ │ Claiming at Age 67 (Full Retirement Age):    │   │
│ │ Monthly Benefit: $[3,700]  Annual: $44,400   │   │
│ │ (100% of Full Retirement Age benefit)        │   │
│ │                                               │   │
│ │ Claiming at Age 70:                           │   │
│ │ Monthly Benefit: $[4,600]  Annual: $55,200   │   │
│ │ (Delayed credits - ~124% of Full Retirement) │   │
│ └───────────────────────────────────────────────┘   │
│                                                      │
│ Note: Get personalized estimates at:                │
│ [Link to ssa.gov My Social Security]                │
│                                                      │
│ [Save Profile]                                       │
└─────────────────────────────────────────────────────┘
```

#### 2. Scenario Creation/Edit Form Enhancement

When creating or editing a scenario, add Social Security claiming age selection:

```
┌─────────────────────────────────────────────────────┐
│ Create/Edit Scenario                               │
├─────────────────────────────────────────────────────┤
│                                                      │
│ SCENARIO PARAMETERS                                 │
│ ...existing fields...                               │
│                                                      │
│ Social Security Claiming Age:                       │
│ ○ Age 62 (Reduced benefit: $30,000/yr)            │
│ ○ Age 65 (Partial benefit: $38,400/yr)            │
│ ◉ Age 67 (Full benefit: $44,400/yr) [Default]     │
│ ○ Age 70 (Delayed benefit: $55,200/yr)            │
│                                                      │
│ [Create Scenario]                                   │
└─────────────────────────────────────────────────────┘
```

#### 3. Scenario Detail Display

Display which Social Security age is being used:

```
Scenario: Baseline Retirement Plan

PARAMETERS SUMMARY
┌──────────────────────────────────────────────────┐
│ Portfolio Value:        $1,000,000               │
│ Retirement Age:         65                       │
│ Life Expectancy:        95                       │
│ Annual Spending:        $80,000                  │
│ Annual Return Rate:     6.5%                     │
│ Social Security:        $44,400/yr (Claiming at age 67) │
│ Pension Income:         $30,000/yr (if applicable)      │
└──────────────────────────────────────────────────┘
```

### Calculator Updates

All existing calculators need to be updated to use age-specific Social Security amounts:

#### Update Strategy for Calculators

1. **In signals.py** - When extracting parameters for calculation:
   ```python
   # Get tax profile to fetch age-specific Social Security benefit
   tax_profile = instance.user.tax_profile
   claiming_age = parameters.get('social_security_claiming_age', 67)

   # Look up the benefit amount for this claiming age
   social_security_annual = tax_profile.get_social_security_annual(claiming_age)

   # Pass to calculator
   calculator = SomeCalculator(
       ...
       social_security_annual=social_security_annual,
       social_security_claiming_age=claiming_age,
   )
   ```

2. **In calculator classes** - Accept claiming age and benefit amount:
   ```python
   class FourPercentCalculator:
       def __init__(
           self,
           ...
           social_security_annual: float,
           social_security_claiming_age: int,
       ):
           self.social_security_annual = social_security_annual
           self.claiming_age = social_security_claiming_age

       def calculate(self):
           # Use self.social_security_annual (already age-adjusted)
           pass
   ```

3. **In scenario detail view** - Display which age/amount is being used:
   ```python
   # In context data
   context['social_security_claiming_age'] = scenario.social_security_claiming_age
   context['social_security_annual'] = (
       user.tax_profile.get_social_security_annual(
           scenario.social_security_claiming_age
       )
   )
   ```

#### Affected Calculators

Update these calculator classes:
- [ ] `FourPercentCalculator`
- [ ] `FourPointSevenPercentCalculator`
- [ ] `MonteCarloCalculator`
- [ ] `EnhancedMonteCarloCalculator`
- [ ] `HistoricalPeriodCalculator`

For each calculator:
- [ ] Add `social_security_claiming_age` parameter
- [ ] Update initialization to accept age-specific benefit
- [ ] Verify calculations use correct annual amount
- [ ] Update result data to include claiming age used
- [ ] Update test cases to test multiple claiming ages

### Migration Strategy

1. **Data Migration**
   ```python
   # Create migration to add new fields to TaxProfile
   - Add social_security_age_62
   - Add social_security_age_65
   - Add social_security_age_67
   - Add social_security_age_70
   - Populate with existing social_security_annual (default to age 67)
   - Drop social_security_annual field (after deprecation period)
   ```

2. **Backward Compatibility**
   - Keep `social_security_annual` field during transition
   - Add property method for compatibility:
     ```python
     @property
     def social_security_annual(self) -> Decimal:
         """Backward compatibility property - returns age 67 benefit"""
         return self.social_security_age_67 * 12
     ```

3. **Timeline**
   - Phase 0: Add new fields, keep old field
   - Phase 0 + 2 weeks: Migrate data, update calculators
   - Phase 0 + 4 weeks: Remove old field after validation

### Testing Strategy

#### Unit Tests

```python
# tests/unit/test_tax_profile.py
- test_get_social_security_annual_age_62
- test_get_social_security_annual_age_65
- test_get_social_security_annual_age_67
- test_get_social_security_annual_age_70
- test_get_social_security_annual_invalid_age_raises_error
- test_get_social_security_annual_returns_monthly_times_12
- test_backward_compatibility_property

# tests/unit/test_scenario_model.py
- test_social_security_claiming_age_defaults_to_67
- test_social_security_claiming_age_choices_valid
```

#### Integration Tests

```python
# tests/integration/test_calculator_with_ss_age.py
- test_four_percent_calculator_with_ss_age_62
- test_four_percent_calculator_with_ss_age_67
- test_four_percent_calculator_with_ss_age_70
- test_monte_carlo_with_different_ss_ages
- test_historical_period_with_ss_age_selection
- test_scenario_detail_shows_correct_ss_amount

# tests/integration/test_financial_profile_forms.py
- test_financial_profile_form_accepts_ss_by_age
- test_financial_profile_form_validates_ss_amounts
- test_financial_profile_form_shows_annual_equivalents

# tests/integration/test_scenario_forms.py
- test_scenario_form_has_ss_claiming_age_field
- test_scenario_form_defaults_to_age_67
```

#### E2E Tests

```python
# tests/e2e/test_social_security_age_flow.py
- test_complete_ss_entry_and_calculation_flow
- test_scenario_comparison_with_different_ss_ages
- test_ss_age_change_updates_results
```

### Backward Compatibility

Existing scenarios and users:
- All existing users' `financial_profile.social_security_annual` will be copied to `social_security_age_67`
- Existing scenarios default to age 67 claiming
- No breaking changes to API

### Files Modified

```
jretirewise/
├── financial/
│   ├── models.py              # MODIFY: TaxProfile model
│   ├── forms.py               # MODIFY: Add SS by-age form fields
│   ├── views.py               # MODIFY: Display multiple SS amounts
│   └── migrations/            # NEW: Data migration
├── scenarios/
│   ├── models.py              # MODIFY: Add claiming_age field
│   ├── forms.py               # MODIFY: Add claiming_age selector
│   ├── views.py               # MODIFY: Pass claiming age to calculators
│   ├── signals.py             # MODIFY: Use age-specific benefit lookup
│   └── migrations/            # NEW: Data migration
├── calculations/
│   ├── calculators.py         # MODIFY: Update all calculators
│   └── tests/                 # MODIFY: Update calculator tests
└── templates/
    ├── financial/profile.html # MODIFY: Show SS by age
    └── scenarios/
        ├── form.html          # MODIFY: Add claiming age selector
        └── detail.html        # MODIFY: Show claiming age used

tests/
├── unit/
│   ├── test_tax_profile.py    # NEW
│   └── test_scenario_model.py # MODIFY
├── integration/
│   ├── test_calculator_ss_age.py        # NEW
│   ├── test_financial_profile_forms.py  # MODIFY
│   └── test_scenario_forms.py           # MODIFY
└── e2e/
    └── test_social_security_age_flow.py # NEW
```

### Implementation Timeline

**Week 1:**
- [ ] Create TaxProfile migration with new SS fields
- [ ] Create RetirementScenario migration with claiming_age field
- [ ] Update models with new fields and methods
- [ ] Write unit tests for new model methods
- [ ] Create data migration script

**Week 2:**
- [ ] Update financial profile form and template
- [ ] Update scenario creation/edit form
- [ ] Update all calculator classes (5 calculators)
- [ ] Update signals.py to use age-specific lookup
- [ ] Write integration tests for calculators
- [ ] Update scenario detail template
- [ ] Write E2E tests
- [ ] Test backward compatibility

### Success Criteria

- [ ] TaxProfile stores benefits for all 4 claiming ages
- [ ] `get_social_security_annual()` method works for ages 62, 65, 67, 70
- [ ] All calculators accept and use claiming age parameter
- [ ] Scenarios default to age 67, allow selection of other ages
- [ ] Results change appropriately based on claiming age selected
- [ ] Backward compatibility maintained for existing users
- [ ] 100% test coverage for new model methods
- [ ] 90%+ integration test coverage for calculator changes
- [ ] UI clearly shows which age/benefit is being used
- [ ] Data migration completes without data loss

### Dependencies on This Phase

This phase is **BLOCKING** for:
- Feature 2.3.4 (Tax-Aware Calculations)
- Feature 2.3.3 (Sensitivity Analysis) - if including SS claiming age sensitivity
- Any future features that model Social Security strategically

### Notes for Implementation

1. **Social Security Estimates**: Users should get estimates from ssa.gov (My Social Security tool), not from in-app calculators
2. **Claiming Age Impact**: Make visible in results that claiming age significantly impacts retirement success
3. **Scenario Comparison**: Enable users to create scenarios for ages 62, 67, and 70 to see impact
4. **Migration Caution**: Test data migration thoroughly - don't lose existing SS amounts

---

## 2. Feature 2.3.4: Tax-Aware Calculations

### Overview

Tax-Aware Calculations is an **analytical enhancement** to existing scenarios that helps users understand the tax impact on their retirement withdrawals and optimize withdrawal sequences. Features include:

1. **Basic Income Tax Estimation** - Estimate federal income tax based on withdrawal amount and filing status for each year of retirement
2. **Withdrawal Sequencing Strategies** - Compare different withdrawal approaches (Roth first, tax-deferred first, optimized) to minimize taxes on an existing scenario
3. **Tax Impact Visualization** - Show how different withdrawal strategies affect taxes, after-tax income, and long-term wealth

### Architectural Approach

**NOT a new scenario type** - Instead:
- Operates on withdrawal amounts from existing `RetirementScenario` calculations
- Creates `WithdrawalStrategy` and `TaxEstimate` records linked to the scenario
- Shows as a tab/panel on the scenario detail page
- Allows comparing tax strategies and viewing tax breakdowns without creating separate scenarios
- Requires Phase 0 (Social Security Profile Enhancement) for age-specific benefit handling

### Requirements

**Key Principle**: Tax-Aware Calculations operates on existing scenarios, not replacing them. Takes withdrawal amounts from existing scenario and applies tax analysis.

#### Functional Requirements

1. **Tax Profile Setup** (Pre-requisite)
   - User enters tax information once (in financial profile)
   - Can then apply to multiple scenarios

2. **Withdrawal Strategy Selection**
   - Users select an existing scenario
   - Choose withdrawal strategy to apply to that scenario
   - Compare tax outcomes across different strategies
   - No new scenario is created

3. **Tax Parameters**
   - Filing status (Single, Married Filing Jointly, Head of Household)
   - State of residence
   - Social Security timing and amount
   - Pension income
   - Other income sources

2. **Tax Calculations**
   - Federal income tax estimation using current year brackets
   - Social Security taxation (0%, 50%, or 85% of benefits as income)
   - Medicare premiums based on MAGI (Income-Related Monthly Adjustment Amount)
   - State income tax (optional, multi-state support)
   - Net Investment Income Tax (NIIT - 3.8% on unearned income >$200k/$250k)

3. **Withdrawal Sequencing**
   - Traditional IRA/401k contributions
   - Roth IRA contributions
   - Taxable brokerage accounts
   - HSA accounts (special rules)
   - Tax-loss harvesting opportunities
   - RMD (Required Minimum Distribution) impact

4. **Visualization**
   - Tax breakdown by year
   - Effective tax rate calculation
   - After-tax vs pre-tax withdrawal amounts
   - Comparison of different withdrawal sequences
   - Social Security taxation impact

#### Technical Requirements

1. **Backend**
   - New `TaxCalculator` class with 2025 tax brackets
   - `WithdrawalSequencer` for optimization
   - Account-type aware calculations
   - State tax support (pluggable structure)

2. **Frontend**
   - Tax parameters form
   - Tax rate input/display
   - Withdrawal strategy comparison
   - Tax breakdown visualization

3. **Database**
   - `TaxProfile` model (user's tax information)
   - `WithdrawalStrategy` model (saved strategies)
   - `TaxEstimate` model (calculated tax data)

### Data Models

#### New Models

```python
class TaxProfile(models.Model):
    """User's tax information for tax-aware calculations"""
    user = OneToOneField(User, on_delete=models.CASCADE)

    # Filing status
    FILING_STATUS_CHOICES = [
        ('single', 'Single'),
        ('married_joint', 'Married Filing Jointly'),
        ('married_separate', 'Married Filing Separately'),
        ('head_of_household', 'Head of Household'),
    ]
    filing_status = CharField(max_length=20, choices=FILING_STATUS_CHOICES)

    # Location
    state_of_residence = CharField(max_length=2, default='CA')
    has_state_tax = BooleanField(default=True)

    # Income sources
    pension_annual = DecimalField(max_digits=12, decimal_places=2, default=0)
    pension_taxable_percentage = FloatField(default=0.85)

    social_security_annual = DecimalField(max_digits=12, decimal_places=2, default=0)
    social_security_start_age = IntegerField(null=True, blank=True)

    other_income_annual = DecimalField(max_digits=12, decimal_places=2, default=0)

    # Deductions
    standard_deduction_override = DecimalField(
        max_digits=12, decimal_places=2, null=True, blank=True
    )

    # Account types and amounts
    traditional_ira_balance = DecimalField(max_digits=12, decimal_places=2, default=0)
    roth_ira_balance = DecimalField(max_digits=12, decimal_places=2, default=0)
    taxable_account_balance = DecimalField(max_digits=12, decimal_places=2, default=0)
    hsa_balance = DecimalField(max_digits=12, decimal_places=2, default=0)

    # Basis in taxable accounts (for capital gains calculation)
    taxable_account_basis = DecimalField(max_digits=12, decimal_places=2, default=0)

    created_at = DateTimeField(auto_now_add=True)
    updated_at = DateTimeField(auto_now=True)


class WithdrawalStrategy(models.Model):
    """Saved withdrawal sequencing strategy"""
    scenario = ForeignKey(RetirementScenario, on_delete=models.CASCADE)
    name = CharField(max_length=255)
    description = TextField(blank=True)

    SEQUENCE_CHOICES = [
        ('taxable_first', 'Taxable First'),
        ('tax_deferred_first', 'Tax-Deferred First (401k/Trad IRA)'),
        ('roth_first', 'Roth First'),
        ('optimized', 'Optimized (Minimize Taxes)'),
        ('custom', 'Custom'),
    ]
    strategy_type = CharField(max_length=20, choices=SEQUENCE_CHOICES, default='optimized')

    # For custom strategies, specify percentage from each account
    taxable_percentage = FloatField(default=0.0)  # 0.0-1.0
    traditional_percentage = FloatField(default=0.0)
    roth_percentage = FloatField(default=0.0)
    hsa_percentage = FloatField(default=0.0)

    # Constraints
    preserve_roth_growth = BooleanField(default=True)
    minimize_social_security_taxation = BooleanField(default=False)

    created_at = DateTimeField(auto_now_add=True)
    updated_at = DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']


class TaxEstimate(models.Model):
    """Calculated tax liability for a year"""
    scenario = ForeignKey(RetirementScenario, on_delete=models.CASCADE)
    withdrawal_strategy = ForeignKey(WithdrawalStrategy, on_delete=models.SET_NULL, null=True)

    year = IntegerField()  # Retirement year 1, 2, 3...
    age = IntegerField()

    # Income breakdown
    gross_withdrawal = DecimalField(max_digits=12, decimal_places=2)
    taxable_withdrawal = DecimalField(max_digits=12, decimal_places=2)
    tax_deferred_withdrawal = DecimalField(max_digits=12, decimal_places=2)
    roth_withdrawal = DecimalField(max_digits=12, decimal_places=2)
    hsa_withdrawal = DecimalField(max_digits=12, decimal_places=2)

    # Tax calculations
    ordinary_income = DecimalField(max_digits=12, decimal_places=2)
    capital_gains_income = DecimalField(max_digits=12, decimal_places=2)
    social_security_taxable = DecimalField(max_digits=12, decimal_places=2)

    agi = DecimalField(max_digits=12, decimal_places=2)  # Adjusted Gross Income
    magi = DecimalField(max_digits=12, decimal_places=2)  # Modified AGI

    # Tax liability
    federal_tax = DecimalField(max_digits=12, decimal_places=2)
    state_tax = DecimalField(max_digits=12, decimal_places=2, default=0)
    niit_tax = DecimalField(max_digits=12, decimal_places=2, default=0)  # Net Investment Income Tax
    medicare_surcharge = DecimalField(max_digits=12, decimal_places=2, default=0)

    total_tax = DecimalField(max_digits=12, decimal_places=2)
    effective_tax_rate = FloatField()  # total_tax / agi

    # After-tax result
    after_tax_amount = DecimalField(max_digits=12, decimal_places=2)

    created_at = DateTimeField(auto_now_add=True)
```

### Implementation Approach

#### Phase 1: Tax Calculation Engine

1. **Create `TaxCalculator` Class**
   ```python
   class TaxCalculator:
       def __init__(self, tax_profile: TaxProfile, year: int):
           self.tax_profile = tax_profile
           self.year = year
           self.tax_brackets = self._get_2025_tax_brackets()

       def calculate_federal_tax(self, ordinary_income, capital_gains):
           # Apply 2025 tax brackets
           # Handle capital gains rates (0%, 15%, 20%)
           pass

       def calculate_social_security_tax(self, ss_benefit, other_income):
           # 0%, 50%, or 85% of SS becomes taxable
           pass

       def calculate_niit(self, investment_income, magi):
           # 3.8% on net investment income if MAGI exceeds threshold
           pass

       def calculate_medicare_surcharge(self, magi):
           # IRMAA: 0.9% Medicare surtax on wages/SE income
           # Additional Medicare tax on high earners
           pass

       def calculate_state_tax(self, agi):
           # Pluggable state-specific calculation
           pass
   ```

2. **Create `WithdrawalSequencer` Class**
   ```python
   class WithdrawalSequencer:
       def __init__(self, scenario: RetirementScenario, tax_profile: TaxProfile):
           self.scenario = scenario
           self.tax_profile = tax_profile

       def optimize_sequence(self, annual_withdrawal_need):
           # For each account type, calculate tax impact
           # Find sequence that minimizes total tax
           pass

       def compare_strategies(self, strategies: List[WithdrawalStrategy]):
           # Compare tax outcomes for different strategies
           pass

       def calculate_rmd(self, age, account_balance):
           # Required Minimum Distribution calculation
           pass
   ```

3. **Integration with Existing Calculators**
   - Modify `FourPercentCalculator` to support tax-aware mode
   - Integrate `TaxCalculator` into withdrawal calculations
   - Store tax estimates alongside portfolio values

#### Phase 2: Frontend Interface

1. **Tax Profile Setup Page** (`/financial/tax-profile/`)
   - Form for entering tax information
   - Filing status selection
   - Account balance inputs
   - State of residence

2. **Withdrawal Strategy Configuration** (`/scenarios/<pk>/withdrawal-strategy/`)
   - Strategy type selection (Taxable First, Tax-Deferred First, etc.)
   - Custom percentage allocation
   - Strategy comparison

3. **Tax Impact Display** (Enhanced scenario detail page)
   - Tax breakdown by year
   - Effective tax rate visualization
   - After-tax vs pre-tax withdrawal comparison
   - Social Security taxation indicator

#### Phase 3: Advanced Features

1. **Tax-Loss Harvesting Recommendations**
   - Identify years with gains in taxable accounts
   - Suggest offsetting losses

2. **State Tax Optimization**
   - Multi-state comparison
   - Residency change impact analysis

3. **Roth Conversion Analysis**
   - Evaluate benefits of converting Traditional to Roth
   - Tax impact modeling

### API Design

#### Endpoints

```
POST /api/tax-profiles/
  Input: { filing_status, state, pension_annual, etc. }
  Output: { tax_profile_id, status: created }

GET /api/tax-profiles/<pk>/
  Output: { tax profile details }

PUT /api/tax-profiles/<pk>/
  Input: { updated fields }
  Output: { updated tax profile }

POST /api/scenarios/<pk>/calculate-taxes/
  Input: {
    withdrawal_strategy_id: int,
    annual_withdrawal: float,
    year: int
  }
  Output: {
    federal_tax: float,
    state_tax: float,
    effective_rate: float,
    after_tax_amount: float
  }

POST /api/scenarios/<pk>/compare-strategies/
  Input: {
    strategy_ids: [1, 2, 3],
    annual_withdrawal: float
  }
  Output: {
    strategies: [
      { id, name, total_tax, effective_rate, after_tax },
      ...
    ]
  }

GET /api/scenarios/<pk>/tax-estimates/
  Output: [ { year, age, tax_breakdown, after_tax }, ... ]

POST /api/scenarios/<pk>/rmd-calculation/
  Input: { age, account_balance }
  Output: { rmd_amount, impact_on_withdrawal }
```

### UI/UX Design

#### Tax Profile Page Layout

```
┌─────────────────────────────────────────────┐
│ Financial Profile > Tax Information         │
├─────────────────────────────────────────────┤
│                                              │
│ FILING STATUS & RESIDENCE                    │
│ ┌──────────────────────────────────────┐   │
│ │ Filing Status: [Married Filing ▼]   │   │
│ │ State: [California ▼]                │   │
│ └──────────────────────────────────────┘   │
│                                              │
│ INCOME SOURCES                               │
│ ┌──────────────────────────────────────┐   │
│ │ Pension Annual:        $[50,000]     │   │
│ │ Pension % Taxable:     [85%]         │   │
│ │ Social Security Start:  Age [67]     │   │
│ │ Estimated SS Annual:   $[36,000]     │   │
│ └──────────────────────────────────────┘   │
│                                              │
│ ACCOUNT BALANCES                             │
│ ┌──────────────────────────────────────┐   │
│ │ Traditional IRA/401(k): $[500,000]   │   │
│ │ Roth IRA:               $[200,000]   │   │
│ │ Taxable Brokerage:      $[300,000]   │   │
│ │ Taxable Cost Basis:     $[250,000]   │   │
│ │ HSA:                    $[50,000]    │   │
│ └──────────────────────────────────────┘   │
│                                              │
│ [Save Profile]                               │
└─────────────────────────────────────────────┘
```

#### Withdrawal Strategy Page Layout

```
┌─────────────────────────────────────────────┐
│ Scenario > Withdrawal Strategy              │
├─────────────────────────────────────────────┤
│                                              │
│ STRATEGY SELECTION                           │
│ ┌──────────────────────────────────────┐   │
│ │ ◉ Taxable First                      │   │
│ │ ○ Tax-Deferred First (401k/IRA)     │   │
│ │ ○ Roth First                         │   │
│ │ ○ Optimized (Minimize Taxes)         │   │
│ │ ○ Custom                             │   │
│ └──────────────────────────────────────┘   │
│                                              │
│ CUSTOM ALLOCATION (if selected)              │
│ ┌──────────────────────────────────────┐   │
│ │ Taxable:       [30%]                 │   │
│ │ Traditional:   [50%]                 │   │
│ │ Roth:          [20%]                 │   │
│ │ HSA:           [0%]                  │   │
│ └──────────────────────────────────────┘   │
│                                              │
│ OPTIONS                                      │
│ ☑ Preserve Roth Growth                      │
│ ☑ Minimize Social Security Taxation          │
│                                              │
│ [Save Strategy]  [Compare]                   │
└─────────────────────────────────────────────┘
```

#### Tax Breakdown Visualization

```
┌─────────────────────────────────────────────┐
│ Scenario Detail > Tax Impact                │
├─────────────────────────────────────────────┤
│                                              │
│ ANNUAL TAX SUMMARY (Year 1, Age 67)         │
│ ┌──────────────────────────────────────┐   │
│ │ Gross Withdrawal:     $100,000       │   │
│ │ Taxable Income:       $ 85,000       │   │
│ │                                      │   │
│ │ Federal Tax:          $ 17,500       │   │
│ │ State Tax (CA):        $ 4,250       │   │
│ │ Medicare Surcharge:    $    765       │   │
│ │ ─────────────────────────────────    │   │
│ │ Total Tax:            $ 22,515 (22.5%)│   │
│ │ After-Tax:            $ 77,485       │   │
│ └──────────────────────────────────────┘   │
│                                              │
│ STRATEGY COMPARISON                          │
│ ┌──────────────────────────────────────┐   │
│ │ Strategy          Tax Rate  After-Tax  │   │
│ │ Taxable First     22.5%     $77,485   │   │
│ │ Tax-Def First     24.1%     $75,900   │   │
│ │ Optimized         21.8%     $78,200   │   │
│ └──────────────────────────────────────┘   │
│                                              │
│ 25-YEAR TAX PROJECTION                       │
│ ┌──────────────────────────────────────┐   │
│ │ [Stacked bar chart: Fed, State, NIIT]│   │
│ └──────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

### Testing Strategy

#### Unit Tests

```python
# tests/unit/calculations/test_tax_calculator.py
- test_federal_tax_calculation_2025_brackets
- test_capital_gains_treatment (0%, 15%, 20%)
- test_social_security_taxation (0%, 50%, 85%)
- test_niit_calculation
- test_medicare_surcharge
- test_state_tax_calculation

# tests/unit/calculations/test_withdrawal_sequencer.py
- test_taxable_first_strategy
- test_tax_deferred_first_strategy
- test_roth_first_strategy
- test_optimized_sequencing
- test_rmd_calculation
- test_strategy_comparison
```

#### Integration Tests

```python
# tests/integration/test_tax_profile_views.py
- test_create_tax_profile
- test_update_tax_profile
- test_tax_profile_validation

# tests/integration/test_withdrawal_strategy_views.py
- test_create_withdrawal_strategy
- test_update_withdrawal_strategy
- test_compare_strategies

# tests/integration/test_tax_calculator_integration.py
- test_tax_aware_4_percent_calculation
- test_tax_impact_on_success_rate
- test_year_by_year_tax_breakdown
```

#### E2E Tests

```python
# tests/e2e/test_tax_aware_flow.py
- test_complete_tax_setup_and_calculation
- test_withdrawal_strategy_comparison
- test_tax_breakdown_visualization
```

### Success Criteria

- [ ] Tax calculator produces results within 1% of manual 2025 tax bracket calculation
- [ ] Withdrawal sequencer optimizes tax outcomes vs baseline approach
- [ ] Tax profiles saved and retrieved correctly
- [ ] State tax calculation pluggable and extensible
- [ ] 100% unit test coverage for tax calculations
- [ ] 80%+ integration test coverage
- [ ] Tax breakdowns shown for all scenarios
- [ ] RMD calculation accurate for all ages

---

## Integration Between 2.3.3 & 2.3.4

These features work together synergistically:

1. **Sensitivity Analysis with Tax Consideration**
   - When adjusting parameters in sensitivity analysis, show tax impact
   - "What if returns are 2% lower?" → also show how this affects tax bracket

2. **Tax-Aware Optimization**
   - Withdrawal sequencing affects portfolio longevity
   - Sensitivity analysis can test robustness of different tax strategies

3. **Combined Scenarios**
   - Compare scenarios with different tax strategies
   - Show how tax optimization improves success rates

4. **Shared Models**
   - Both use `RetirementScenario` and `CalculationResult`
   - Both extend existing calculator framework
   - Both store results in structured `result_data` JSON

---

## Development Timeline

### Week 1-2: Setup & Tax Engine
- [ ] Create data models (TaxProfile, WithdrawalStrategy, TaxEstimate)
- [ ] Implement TaxCalculator class with 2025 brackets
- [ ] Unit tests for tax calculations
- [ ] State tax framework (CA as example)

### Week 2-3: Tax Integration
- [ ] Integrate TaxCalculator into existing calculators
- [ ] Create WithdrawalSequencer class
- [ ] WithdrawalStrategy comparison logic
- [ ] Integration tests

### Week 3-4: Frontend - Tax
- [ ] Tax profile form page
- [ ] Withdrawal strategy selection/configuration
- [ ] Tax breakdown visualization
- [ ] E2E tests

### Week 4-5: Sensitivity Analysis Backend
- [ ] Create SensitivityAnalyzer class
- [ ] Tornado chart data generation
- [ ] Batch calculation optimization
- [ ] Unit tests

### Week 5-6: Sensitivity Analysis Frontend
- [ ] Sensitivity analysis page with sliders
- [ ] Real-time calculation and updates
- [ ] Tornado chart visualization
- [ ] Save/compare sensitivity scenarios
- [ ] E2E tests

### Week 6+: Polish & Advanced Features
- [ ] Performance optimization
- [ ] Additional state tax support
- [ ] Roth conversion analysis
- [ ] Documentation

---

## Risk Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Tax bracket accuracy | Low | High | Use IRS published 2025 brackets, annual review process |
| Performance (batch calculations) | Medium | Medium | Implement caching, async processing if needed |
| State tax complexity | Medium | Medium | Start with CA, template for others, pluggable design |
| Complex withdrawal rules | High | High | Extensive unit tests, IRS validation, phased implementation |
| UI complexity (too many options) | Medium | Medium | Clear defaults, guided setup, collapse advanced options |

---

## Success Metrics

### Feature 2.3.3 (Sensitivity Analysis)
- 95%+ of scenarios run in <5 seconds
- Users create 2+ sensitivity scenarios on average
- Tornado chart correctly ranks parameters by impact
- 100% test coverage on calculator

### Feature 2.3.4 (Tax-Aware Calculations)
- Tax estimates within $500 (1%) of manual calculation for median scenario
- Users adopt at least one tax strategy adjustment
- RMD calculations accurate for ages 70-95
- 100% test coverage on tax logic

### Combined
- Scenarios with tax optimization show measurable improvement
- Sensitivity analysis correctly adjusts for tax impact
- User satisfaction >4/5 for clarity of results

---

## Future Enhancements (Post-Phase 2)

1. **Advanced Tax Features**
   - Multi-state analysis
   - Roth conversion ladder strategy
   - Tax-loss harvesting automation
   - Alternative Minimum Tax (AMT) calculation

2. **Sensitivity Extensions**
   - Mortality rate sensitivity
   - Life expectancy uncertainty analysis
   - Correlation analysis (returns vs inflation)

3. **Integration**
   - Import actual historical tax returns
   - Sync with tax software (TurboTax, etc.)
   - Real-time market data integration

---

## Dependencies & Prerequisites

### External Dependencies
- 2025 IRS Tax Brackets (yearly update)
- State tax rate tables (CA, NY, TX, etc.)
- Census bureau IRMAA income thresholds
- Social Security benefit taxation rules

### Internal Dependencies
- Existing calculator framework (4%, 4.7%, Monte Carlo)
- RetirementScenario model
- CalculationResult model
- User authentication

### Library Dependencies
- `django` (existing)
- `numpy/scipy` (for calculations, existing)
- `pandas` (for data manipulation)
- `chart.js` (frontend, existing)

---

## File Structure

```
jretirewise/
├── calculations/
│   ├── tax_calculator.py          # NEW
│   ├── withdrawal_sequencer.py    # NEW
│   ├── sensitivity_analyzer.py    # NEW
│   └── calculators.py             # MODIFY (integrate tax/sensitivity)
├── financial/
│   ├── models.py                  # MODIFY (add TaxProfile)
│   ├── forms.py                   # MODIFY (add TaxProfileForm)
│   └── views.py                   # MODIFY (add tax profile views)
├── scenarios/
│   ├── models.py                  # MODIFY (add Withdrawal/Sensitivity models)
│   ├── forms.py                   # MODIFY (add strategy forms)
│   ├── views.py                   # MODIFY (add sensitivity/tax views)
│   └── urls.py                    # MODIFY (add new endpoints)
├── api/
│   ├── views.py                   # MODIFY (add tax/sensitivity endpoints)
│   └── serializers.py             # MODIFY (add new serializers)
└── templates/
    ├── financial/tax_profile.html       # NEW
    ├── scenarios/withdrawal_strategy.html # NEW
    └── scenarios/sensitivity_analysis.html # NEW

tests/
├── unit/
│   ├── test_tax_calculator.py           # NEW
│   ├── test_withdrawal_sequencer.py     # NEW
│   └── test_sensitivity_analyzer.py     # NEW
├── integration/
│   ├── test_tax_profile_views.py        # NEW
│   ├── test_withdrawal_strategy_views.py # NEW
│   └── test_sensitivity_views.py        # NEW
└── e2e/
    ├── test_tax_aware_flow.py           # NEW
    └── test_sensitivity_flow.py         # NEW
```

---

## Appendix A: 2025 Federal Tax Brackets

**Single Filers:**
- 10%: $0 - $11,600
- 12%: $11,601 - $47,150
- 22%: $47,151 - $100,525
- 24%: $100,526 - $191,950
- 32%: $191,951 - $243,725
- 35%: $243,726 - $609,350
- 37%: $609,351+

**Married Filing Jointly:**
- 10%: $0 - $23,200
- 12%: $23,201 - $94,300
- 22%: $94,301 - $201,050
- 24%: $201,051 - $383,900
- 32%: $383,901 - $487,450
- 35%: $487,451 - $731,200
- 37%: $731,201+

**Capital Gains (Long-term, 2025):**
- 0%: Up to $47,025 (Single) / $94,050 (MFJ)
- 15%: $47,026-$518,900 (Single) / $94,051-$583,750 (MFJ)
- 20%: $518,901+ (Single) / $583,751+ (MFJ)

---

## Appendix B: Tax Profile Setup Workflow

```
User Action          |  System Response
─────────────────────┼──────────────────────────────
Login                │ Check if TaxProfile exists
                     │ If not, show setup wizard
Select "Tax Profile" │ Load tax profile form
Fill form:           │ Validate inputs
- Filing status      │ Save to database
- State              │ Show confirmation
- Account balances   │
Submit               │ Ready for tax calculations
```

---

## References

- IRS Publication 17: Your Federal Income Tax
- IRS Publication 590-A: Contributions to Individual Retirement Arrangements (IRAs)
- IRS Publication 590-B: Distributions from Individual Retirement Arrangements (IRAs)
- Social Security: How Work Affects Your Benefits
- Medicare IRMAA Income Limits
- The Tax Code of Withdrawal Sequencing (academic paper)
- Bogleheads Tax Efficient Investing Forum

