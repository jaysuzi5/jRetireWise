{% extends "base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}{{ scenario.name }} - jRetireWise{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ scenario.name }}</h1>
    <p class="text-gray-600 dark:text-gray-400 mt-2">{{ scenario.description }}</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
    <!-- Scenario Stats -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Calculator</h3>
        <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">{{ scenario.get_calculator_type_display }}</p>
    </div>

    {% if scenario.result %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Status</h3>
            <p class="text-2xl font-bold mt-2">
                {% if scenario.result.status == 'completed' %}
                    <span class="text-green-600 dark:text-green-400">Completed</span>
                {% elif scenario.result.status == 'pending' %}
                    <span class="text-yellow-600 dark:text-yellow-400">Running</span>
                {% else %}
                    <span class="text-red-600 dark:text-red-400">Failed</span>
                {% endif %}
            </p>
        </div>

        {% if scenario.result.status == 'failed' %}
            <div class="col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Error</h3>
                <p class="text-gray-900 dark:text-white mt-2">{{ scenario.result.error_message }}</p>
            </div>
        {% else %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Success Rate</h3>
                <p class="text-2xl font-bold mt-2">
                    {% if scenario.result.result_data.calculation.success_rate is not None %}
                        {% with scenario.result.result_data.calculation.success_rate as rate %}
                            <span class="{% if rate >= 90 %}text-green-600 dark:text-green-400{% elif rate >= 75 %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                {{ rate|floatformat:1 }}%
                            </span>
                        {% endwith %}
                    {% elif scenario.result.result_data.summary.success_rate is not None %}
                        {% with scenario.result.result_data.summary.success_rate as rate %}
                            <span class="{% if rate >= 90 %}text-green-600 dark:text-green-400{% elif rate >= 75 %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                {{ rate|floatformat:1 }}%
                            </span>
                        {% endwith %}
                    {% else %}
                        <span class="text-gray-900 dark:text-white">—</span>
                    {% endif %}
                </p>
            </div>
        {% endif %}

    {% endif %}
</div>

<!-- Enhanced Monte Carlo Results -->
{% if scenario.calculator_type == 'monte_carlo' and scenario.result and scenario.result.status == 'completed' %}
{% with scenario.result.result_data.calculation as calc %}


<!-- Monte Carlo Results Summary -->
{% if calc.yearly_percentiles %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 mb-6">Results</h2>

    <!-- Key Results -->
    <div class="space-y-3 mb-8">
        {% if calc.mode == 'find_withdrawal' %}
        <!-- Find Withdrawal Mode Results -->
        <div class="flex items-baseline">
            <span class="text-gray-600 dark:text-gray-400 mr-2">Target Success Rate:</span>
            <span class="text-xl font-bold text-indigo-500">{{ calc.achieved_success_rate|floatformat:1 }}%</span>
        </div>
        <div class="flex items-baseline flex-wrap">
            <span class="text-gray-600 dark:text-gray-400 mr-2">Safe Withdrawal:</span>
            <span class="text-xl font-bold text-green-600">${{ calc.safe_withdrawal_annual|floatformat:0|intcomma }}</span>
            {% if calc.four_percent_comparison %}
            <span class="text-gray-500 dark:text-gray-400 mx-2">as compared to</span>
            <span class="text-xl font-bold text-green-600">${{ calc.four_percent_comparison.withdrawal_annual|floatformat:0|intcomma }}</span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">at the 4 percent rule</span>
            {% endif %}
        </div>
        {% else %}
        <!-- Evaluate Success Mode Results -->
        <div class="flex items-baseline">
            <span class="text-gray-600 dark:text-gray-400 mr-2">Monte Carlo Success Rate:</span>
            <span class="text-xl font-bold {% if calc.success_rate >= 90 %}text-green-600{% elif calc.success_rate >= 75 %}text-yellow-500{% else %}text-red-500{% endif %}">{{ calc.success_rate|floatformat:1 }}%</span>
        </div>
        <div class="flex items-baseline flex-wrap">
            <span class="text-gray-600 dark:text-gray-400 mr-2">Withdrawal:</span>
            <span class="text-xl font-bold text-green-600">${{ calc.withdrawal_annual|floatformat:0|intcomma }}</span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">({{ calc.withdrawal_rate|floatformat:2 }}% of portfolio)</span>
            {% if calc.four_percent_comparison %}
            <span class="text-gray-500 dark:text-gray-400 mx-2">as compared to</span>
            <span class="text-xl font-bold text-green-600">${{ calc.four_percent_comparison.withdrawal_annual|floatformat:0|intcomma }}</span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">at the 4 percent rule</span>
            {% endif %}
        </div>
        {% endif %}

        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-baseline mb-2">
                <span class="text-gray-600 dark:text-gray-400 mr-2">Ending Fixed Rate:</span>
                <span class="text-lg font-semibold text-green-600">
                    {% with calc.constant_return_trajectory|last as last_const %}
                        ${{ last_const.portfolio_value|floatformat:0|intcomma }}
                    {% endwith %}
                </span>
            </div>
            <div class="flex items-baseline mb-2">
                <span class="text-gray-600 dark:text-gray-400 mr-2">Ending Median Rate:</span>
                <span class="text-lg font-semibold text-indigo-400">${{ calc.final_value_percentiles.p50|floatformat:0|intcomma }}</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-gray-600 dark:text-gray-400 mr-2">Ending Target Rate:</span>
                <span class="text-lg font-semibold text-red-400">${{ calc.final_value_percentiles.p10|floatformat:0|intcomma }}</span>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div style="position: relative; height: 400px;">
        <canvas id="mcChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
(function() {
    const ctx = document.getElementById('mcChart').getContext('2d');
    const yearlyPercentiles = {{ calc.yearly_percentiles|safe }};
    const constantReturn = {{ calc.constant_return_trajectory|safe|default:'[]' }};
    const ssStartAge = {{ calc.parameters.social_security_start_age|default:'null' }};
    const ssAnnual = {{ calc.parameters.social_security_annual|default:0 }};
    const pensionStartAge = {{ calc.parameters.pension_start_age|default:'null' }};
    const pensionAnnual = {{ calc.parameters.pension_annual|default:0 }};
    const retirementAge = {{ calc.parameters.retirement_age|default:65 }};

    // Detect dark mode for chart colors
    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? '#ffffff' : '#374151';  // White for dark mode, gray-700 for light
    const gridColor = isDark ? 'rgba(156, 163, 175, 0.3)' : 'rgba(209, 213, 219, 0.5)';  // Brighter grid in dark mode

    const ages = yearlyPercentiles.map(p => p.age);
    const p10 = yearlyPercentiles.map(p => p.p10);  // Target success rate (~90% success)
    const p50 = yearlyPercentiles.map(p => p.p50);  // Median
    const constantValues = constantReturn.map(c => c.portfolio_value);

    // Find index where SS and Pension start (for annotations)
    const ssStartIndex = ssStartAge && ssAnnual > 0 ? ages.indexOf(ssStartAge) : -1;
    const pensionStartIndex = pensionStartAge && pensionAnnual > 0 ? ages.indexOf(pensionStartAge) : -1;

    // Build annotations for SS and Pension if present
    const annotations = {};
    if (ssStartIndex >= 0 && ssAnnual > 0) {
        annotations.ssLine = {
            type: 'line',
            xMin: ssStartIndex,
            xMax: ssStartIndex,
            borderColor: 'rgba(59, 130, 246, 0.7)',
            borderWidth: 2,
            borderDash: [6, 4],
            label: {
                display: true,
                content: 'SS Starts',
                position: 'start',
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                color: 'white',
                font: { size: 11 }
            }
        };
    }
    if (pensionStartIndex >= 0 && pensionAnnual > 0) {
        annotations.pensionLine = {
            type: 'line',
            xMin: pensionStartIndex,
            xMax: pensionStartIndex,
            borderColor: 'rgba(168, 85, 247, 0.7)',
            borderWidth: 2,
            borderDash: [6, 4],
            label: {
                display: true,
                content: 'Pension Starts',
                position: 'start',
                backgroundColor: 'rgba(168, 85, 247, 0.8)',
                color: 'white',
                font: { size: 11 }
            }
        };
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ages,
            datasets: [
                {
                    label: 'Constant Return',
                    data: constantValues,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: true,
                    order: 3
                },
                {
                    label: 'Random Returns: Median',
                    data: p50,
                    borderColor: 'rgb(167, 139, 250)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    order: 2
                },
                {
                    label: 'Random Returns: Target Success',
                    data: p10,
                    borderColor: 'rgb(251, 113, 133)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Age',
                        color: textColor
                    },
                    grid: {
                        color: gridColor
                    },
                    ticks: {
                        color: textColor
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Portfolio Value',
                        color: textColor
                    },
                    grid: {
                        color: gridColor
                    },
                    ticks: {
                        color: textColor,
                        callback: function(value) {
                            if (value >= 1000000) {
                                return '$' + (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        color: textColor,
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                        }
                    }
                },
                annotation: {
                    annotations: annotations
                }
            }
        }
    });
})();
</script>
{% endif %}

<!-- Monte Carlo Parameters -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Simulation Parameters</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Portfolio Value</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">${{ calc.parameters.portfolio_value|floatformat:0|intcomma }}</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Retirement Period</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.years_in_retirement }} years</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Expected Return</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.mean_return|floatformat:1 }}%</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Volatility (Std Dev)</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.return_std_dev|floatformat:1 }}%</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Inflation Rate</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.inflation_rate|floatformat:1 }}%</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Simulations</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.num_simulations|intcomma }}</p>
        </div>
        {% if calc.parameters.social_security_annual and calc.parameters.social_security_annual > 0 %}
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Social Security</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">${{ calc.parameters.social_security_annual|floatformat:0|intcomma }}/yr</p>
            <p class="text-xs text-gray-400">Starting at age {{ calc.parameters.social_security_start_age }}</p>
        </div>
        {% endif %}
        {% if calc.parameters.pension_annual and calc.parameters.pension_annual > 0 %}
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Pension</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">${{ calc.parameters.pension_annual|floatformat:0|intcomma }}/yr</p>
            <p class="text-xs text-gray-400">Starting at age {{ calc.parameters.pension_start_age }}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Income Breakdown by Age Band -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Income Breakdown by Age Band</h2>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="border-b-2 border-gray-200 dark:border-gray-700">
                <tr>
                    <th class="text-left py-3 px-4 text-gray-700 dark:text-gray-300 font-semibold">Age Band</th>
                    <th class="text-right py-3 px-4 text-gray-700 dark:text-gray-300 font-semibold">Portfolio Withdrawal</th>
                    <th class="text-right py-3 px-4 text-gray-700 dark:text-gray-300 font-semibold">Pension</th>
                    <th class="text-right py-3 px-4 text-gray-700 dark:text-gray-300 font-semibold">Social Security</th>
                    <th class="text-right py-3 px-4 text-gray-700 dark:text-gray-300 font-semibold">Total Income</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% with withdrawal=calc.withdrawal_annual|default:0 pension=calc.parameters.pension_annual|default:0 pension_age=calc.parameters.pension_start_age|default:999 ss=calc.parameters.social_security_annual|default:0 ss_age=calc.parameters.social_security_start_age|default:999 ret_age=calc.parameters.retirement_age|default:65 life_exp=calc.parameters.life_expectancy|default:95 %}

                <!-- Band 1: Early Retirement (before any income sources) -->
                {% if pension_age < ss_age %}
                    {% if pension > 0 and pension_age > ret_age %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Early Retirement ({{ ret_age|floatformat:1 }}-{{ pension_age }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">Before pension and Social Security</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|floatformat:0|intcomma }}</td>
                    </tr>
                    {% endif %}
                {% else %}
                    {% if ss > 0 and ss_age > ret_age %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Early Retirement ({{ ret_age|floatformat:1 }}-{{ ss_age }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">Before Social Security{% if pension > 0 %} and pension{% endif %}</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|floatformat:0|intcomma }}</td>
                    </tr>
                    {% endif %}
                {% endif %}

                <!-- Band 2: With pension but before SS, OR with SS but before pension -->
                {% if pension > 0 and ss > 0 and pension_age != ss_age %}
                    {% if pension_age < ss_age %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Retirement with Pension ({{ pension_age }}-{{ ss_age }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">Before Social Security</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-green-600 dark:text-green-400 font-medium">${{ pension|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|add:pension|floatformat:0|intcomma }}</td>
                    </tr>
                    {% elif ss_age < pension_age %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Retirement with Social Security ({{ ss_age }}-{{ pension_age }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">Before pension</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-blue-600 dark:text-blue-400 font-medium">${{ ss|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|add:ss|floatformat:0|intcomma }}</td>
                    </tr>
                    {% endif %}
                {% endif %}

                <!-- Band 3: Full Retirement (with all income sources) -->
                {% if pension > 0 and ss > 0 %}
                    {% if pension_age > ss_age %}
                        {% with final_age=pension_age %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 bg-green-50 dark:bg-green-900/10">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Full Retirement ({{ final_age }}-{{ life_exp }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">With pension and Social Security</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-green-600 dark:text-green-400 font-medium">${{ pension|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-blue-600 dark:text-blue-400 font-medium">${{ ss|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|add:pension|add:ss|floatformat:0|intcomma }}</td>
                    </tr>
                        {% endwith %}
                    {% else %}
                        {% with final_age=ss_age %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 bg-green-50 dark:bg-green-900/10">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Full Retirement ({{ final_age }}-{{ life_exp }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">With pension and Social Security</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-green-600 dark:text-green-400 font-medium">${{ pension|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-blue-600 dark:text-blue-400 font-medium">${{ ss|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|add:pension|add:ss|floatformat:0|intcomma }}</td>
                    </tr>
                        {% endwith %}
                    {% endif %}
                {% elif pension > 0 %}
                    <!-- Only pension, no SS -->
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 bg-green-50 dark:bg-green-900/10">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Retirement with Pension ({{ pension_age }}-{{ life_exp }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">Pension only</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-green-600 dark:text-green-400 font-medium">${{ pension|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|add:pension|floatformat:0|intcomma }}</td>
                    </tr>
                {% elif ss > 0 %}
                    <!-- Only SS, no pension -->
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 bg-green-50 dark:bg-green-900/10">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Retirement with Social Security ({{ ss_age }}-{{ life_exp }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">Social Security only</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-blue-600 dark:text-blue-400 font-medium">${{ ss|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|add:ss|floatformat:0|intcomma }}</td>
                    </tr>
                {% else %}
                    <!-- No pension or SS -->
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="py-3 px-4 text-gray-900 dark:text-white">
                            Retirement ({{ ret_age|floatformat:1 }}-{{ life_exp }})
                            <div class="text-xs text-gray-500 dark:text-gray-400">Portfolio withdrawals only</div>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-medium">${{ withdrawal|floatformat:0|intcomma }}</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-gray-500 dark:text-gray-400">—</td>
                        <td class="py-3 px-4 text-right text-gray-900 dark:text-white font-bold text-lg">${{ withdrawal|floatformat:0|intcomma }}</td>
                    </tr>
                {% endif %}
                {% endwith %}
            </tbody>
        </table>
    </div>
    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded">
        <p class="text-sm text-blue-700 dark:text-blue-300">
            <span class="font-medium">Note:</span> Income amounts shown are initial values. Actual amounts will increase with inflation ({{ calc.parameters.inflation_rate|floatformat:1 }}% annually) throughout retirement.
        </p>
    </div>
</div>
{% endwith %}
{% endif %}

<!-- Standard Scenario Summary (for non-Monte Carlo) -->
{% if scenario.calculator_type != 'monte_carlo' and scenario.result and scenario.result.result_data.calculation.projections %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Scenario Summary</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Initial Portfolio Balance</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                ${{ scenario.result.result_data.calculation.projections.0.portfolio_value|floatformat:0|intcomma }}
            </p>
        </div>
        <div>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Final Portfolio Balance</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                {% with scenario.result.result_data.calculation.projections|last as last_projection %}
                    ${{ last_projection.portfolio_value|floatformat:0|intcomma }}
                {% endwith %}
            </p>
        </div>
        <div>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Initial Annual Withdrawal</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                ${{ scenario.result.result_data.calculation.projections.0.annual_withdrawal|floatformat:0|intcomma }}
            </p>
        </div>
        <div>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Final Annual Withdrawal</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                {% with scenario.result.result_data.calculation.projections|last as last_projection %}
                    ${{ last_projection.annual_withdrawal|floatformat:0|intcomma }}
                {% endwith %}
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- Chart for non-Monte Carlo scenarios -->
{% if scenario.calculator_type != 'monte_carlo' and scenario.result and scenario.result.result_data.calculation.projections %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Portfolio Projection</h2>
    <div style="position: relative; height: 400px;">
        <canvas id="projectionChart"></canvas>
    </div>
</div>

<script>
(function() {
    const ctx = document.getElementById('projectionChart').getContext('2d');
    const projections = {{ scenario.result.result_data.calculation.projections|safe }};

    // Detect dark mode for chart colors
    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? '#ffffff' : '#374151';  // White for dark mode, gray-700 for light
    const gridColor = isDark ? 'rgba(156, 163, 175, 0.15)' : 'rgba(107, 114, 128, 0.1)';

    const ages = projections.map(p => p.age);
    const portfolioValues = projections.map(p => p.portfolio_value);
    const withdrawals = projections.map(p => p.annual_withdrawal);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ages,
            datasets: [
                {
                    label: 'Portfolio Value',
                    data: portfolioValues,
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Annual Withdrawal',
                    data: withdrawals,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Portfolio Value ($)',
                        color: textColor
                    },
                    ticks: {
                        color: textColor
                    },
                    grid: {
                        color: gridColor
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Annual Withdrawal ($)',
                        color: textColor
                    },
                    ticks: {
                        color: textColor
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: textColor
                    }
                }
            }
        }
    });
})();
</script>
{% endif %}

<!-- Scenario Details (for non-Monte Carlo - Monte Carlo has its own parameters section) -->
{% if scenario.calculator_type != 'monte_carlo' %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Scenario Parameters</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- User-provided parameters -->
        {% for key, value in scenario.parameters.items %}
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                {% if key == 'portfolio_value' %}Portfolio Value
                {% elif key == 'current_age' %}Current Age
                {% elif key == 'retirement_age' %}Retirement Age
                {% elif key == 'life_expectancy' %}Life Expectancy
                {% elif key == 'annual_spending' %}Annual Spending
                {% elif key == 'annual_return_rate' %}Annual Return Rate
                {% elif key == 'annual_return' %}Annual Return Rate
                {% elif key == 'inflation_rate' %}Inflation Rate
                {% else %}{{ key|title }}
                {% endif %}
            </label>
            <p class="mt-1 text-lg text-gray-900 dark:text-white">
                {% if key in 'annual_return_rate,annual_return' %}
                    {{ value|as_percentage|floatformat:1 }}%
                {% elif key == 'inflation_rate' %}
                    {{ value|as_percentage|floatformat:1 }}%
                {% elif key in 'current_age,retirement_age' %}
                    {{ value|floatformat:1 }}
                {% elif key in 'portfolio_value,annual_spending' %}
                    ${{ value|floatformat:0|intcomma }}
                {% else %}
                    {{ value }}
                {% endif %}
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">User-provided</p>
        </div>
        {% endfor %}

        <!-- Default values that were used -->
        {% if scenario.result.result_data.defaults_used %}
            {% for key, value in scenario.result.result_data.defaults_used.items %}
                {% if value is not None %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        {% if key == 'portfolio_value' %}Portfolio Value
                        {% elif key == 'current_age' %}Current Age
                        {% elif key == 'retirement_age' %}Retirement Age
                        {% elif key == 'life_expectancy' %}Life Expectancy
                        {% elif key == 'annual_spending' %}Annual Spending
                        {% elif key == 'annual_return_rate' %}Annual Return Rate
                        {% elif key == 'annual_return' %}Annual Return Rate
                        {% elif key == 'inflation_rate' %}Inflation Rate
                        {% else %}{{ key|title }}
                        {% endif %}
                    </label>
                    <p class="mt-1 text-lg text-gray-900 dark:text-white">
                        {% if key in 'annual_return_rate,annual_return' %}
                            {{ value|as_percentage|floatformat:1 }}%
                        {% elif key == 'inflation_rate' %}
                            {{ value|as_percentage|floatformat:1 }}%
                        {% elif key in 'current_age,retirement_age' %}
                            {{ value|floatformat:1 }}
                        {% elif key in 'portfolio_value,annual_spending' %}
                            ${{ value|floatformat:0|intcomma }}
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Default value</p>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    <!-- Display note if using defaults -->
    {% if scenario.result.result_data.defaults_used %}
        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded">
            <p class="text-sm text-blue-700 dark:text-blue-300">
                <span class="font-medium">Note:</span> Some parameters were not specified and were filled in with default values from your financial profile.
            </p>
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Actions -->
<!-- Bucketed Withdrawal Results -->
{% if scenario.calculator_type == 'bucketed_withdrawal' %}
    {% if scenario.withdrawal_buckets.exists %}
        {% if scenario.result and scenario.result.status == 'completed' %}
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-6">Bucketed Withdrawal Results</h2>

                <!-- Summary Stats -->
                {% with scenario.result.result_data.summary as summary %}
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Success Rate</p>
                        <p class="text-2xl font-bold {% if summary.success_rate >= 100 %}text-green-600{% else %}text-red-600{% endif %}">{{ summary.success_rate|floatformat:0 }}%</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Final Portfolio Value</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">${{ summary.final_portfolio_value|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Total Withdrawals</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">${{ summary.total_withdrawals|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Success Status</p>
                        <p class="text-2xl font-bold {% if not summary.portfolio_depleted %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if not summary.portfolio_depleted %}✓ Success{% else %}✗ Failed{% endif %}
                        </p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Years Portfolio Lasted</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ summary.total_projections }}</p>
                    </div>
                </div>
                {% endwith %}

                <!-- Charts -->
                <div class="space-y-6 mb-8">
                    <!-- Income Chart -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Annual Income Over Time</h3>
                        <canvas id="incomeChart" height="100"></canvas>
                    </div>
                    <!-- Portfolio Value Chart -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Portfolio Value Over Time</h3>
                        <canvas id="portfolioChart" height="100"></canvas>
                    </div>
                </div>

                <!-- Year-by-Year Results Table -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Year-by-Year Projections</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Year</th>
                                    <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Age</th>
                                    <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Bucket</th>
                                    <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Rate</th>
                                    <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Withdrawal</th>
                                    <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Income</th>
                                    <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Portfolio (End)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                {% for year_result in scenario.result.bucketed_results.all|slice:":100" %}
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                        <td class="px-4 py-2 text-gray-900 dark:text-white">{{ year_result.year }}</td>
                                        <td class="px-4 py-2 text-gray-900 dark:text-white">{{ year_result.age }}</td>
                                        <td class="px-4 py-2 text-gray-900 dark:text-white font-medium">{{ year_result.bucket.bucket_name }}</td>
                                        <td class="px-4 py-2 text-right text-gray-900 dark:text-white">{{ year_result.target_rate|floatformat:1 }}%</td>
                                        <td class="px-4 py-2 text-right text-gray-900 dark:text-white">${{ year_result.actual_withdrawal|floatformat:0|intcomma }}</td>
                                        <td class="px-4 py-2 text-right text-gray-900 dark:text-white">${{ year_result.total_available_income|floatformat:0|intcomma }}</td>
                                        <td class="px-4 py-2 text-right text-gray-900 dark:text-white font-semibold">${{ year_result.portfolio_value_end|floatformat:0|intcomma }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if scenario.result.bucketed_results.all|length > 100 %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Showing first 100 years of {{ scenario.result.bucketed_results.all|length }} total years</p>
                    {% endif %}
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                // Use projections from result_data (already JSON)
                const bucketedData = {{ scenario.result.result_data.projections|safe }};
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#ffffff' : '#374151';  // White for dark mode, gray-700 for light
                const gridColor = isDark ? 'rgba(156, 163, 175, 0.3)' : 'rgba(209, 213, 219, 0.5)';  // Brighter grid in dark mode

                // Debug logging
                console.log('Bucket charts - isDark:', isDark, 'textColor:', textColor, 'html classes:', document.documentElement.className);

                // Prepare data for charts
                const labels = bucketedData.map(d => d.age);
                const portfolioValues = bucketedData.map(d => parseFloat(d.portfolio_value_end));
                const withdrawals = bucketedData.map(d => parseFloat(d.actual_withdrawal));
                const totalIncome = bucketedData.map(d => parseFloat(d.total_available_income));

                // Portfolio Value Chart
                new Chart(document.getElementById('portfolioChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Portfolio Value',
                            data: portfolioValues,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Age', color: textColor },
                                grid: { color: gridColor },
                                ticks: { color: textColor }
                            },
                            y: {
                                title: { display: true, text: 'Portfolio Value ($)', color: textColor },
                                grid: { color: gridColor },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });

                // Annual Income Chart (Withdrawal + Total Available)
                new Chart(document.getElementById('incomeChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Total Available Income',
                                data: totalIncome,
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 2
                            },
                            {
                                label: 'Portfolio Withdrawal',
                                data: withdrawals,
                                borderColor: '#ef4444',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { color: textColor, padding: 15 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Age', color: textColor },
                                grid: { color: gridColor },
                                ticks: { color: textColor }
                            },
                            y: {
                                title: { display: true, text: 'Annual Income ($)', color: textColor },
                                grid: { color: gridColor },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            </script>
        {% else %}
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 text-center">
                <p class="text-gray-600 dark:text-gray-400 mb-4">Calculation not run yet. Configure your withdrawal buckets and run the calculation to see results.</p>
                <a href="{% url 'bucket-list' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 inline-block">
                    Manage Buckets
                </a>
            </div>
        {% endif %}
    {% else %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 text-center">
            <p class="text-gray-600 dark:text-gray-400 mb-4">No withdrawal buckets configured yet. Create your first bucket to define your retirement strategy.</p>
            <a href="{% url 'bucket-create' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 inline-block">
                Create First Bucket
            </a>
        </div>
    {% endif %}
{% endif %}

<!-- Historical Analysis Results -->
{% if scenario.calculator_type == 'historical' %}
    {% if scenario.result and scenario.result.status == 'completed' %}
        {% with scenario.result.result_data.calculation as data %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-6">Historical Analysis Results</h2>

            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Historical Success Rate</p>
                    <p class="text-2xl font-bold {% if data.success_rate >= 90 %}text-green-600{% elif data.success_rate >= 75 %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {{ data.success_rate|floatformat:1 }}%
                    </p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Periods Tested</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ data.total_periods_tested }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ data.years_tested }}</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Successful / Failed</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">
                        <span class="text-green-600">{{ data.successful_periods }}</span> /
                        <span class="text-red-600">{{ data.failed_periods }}</span>
                    </p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Retirement Period</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ data.years_in_retirement }} years</p>
                </div>
            </div>

            <!-- Best/Worst/Median Cases -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Best Case -->
                <a href="{% url 'historical-period-detail' scenario.pk data.best_case.start_year %}" class="block bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800 hover:shadow-lg hover:border-green-400 dark:hover:border-green-600 transition-all">
                    <h3 class="font-semibold text-green-800 dark:text-green-300 mb-2">Best Case ({{ data.best_case.start_year }}) →</h3>
                    <div class="space-y-1 text-sm">
                        <p class="text-gray-700 dark:text-gray-300">Final Value: <span class="font-medium">${{ data.best_case.final_portfolio_value|floatformat:0|intcomma }}</span></p>
                        <p class="text-gray-700 dark:text-gray-300">Avg Return: <span class="font-medium">{{ data.best_case.average_return|floatformat:1 }}%</span></p>
                    </div>
                    <p class="text-xs text-green-600 dark:text-green-400 mt-2">Click for year-by-year details</p>
                </a>
                <!-- Median Case -->
                <a href="{% url 'historical-period-detail' scenario.pk data.median_case.start_year %}" class="block bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800 hover:shadow-lg hover:border-blue-400 dark:hover:border-blue-600 transition-all">
                    <h3 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">Median Case ({{ data.median_case.start_year }}) →</h3>
                    <div class="space-y-1 text-sm">
                        <p class="text-gray-700 dark:text-gray-300">Final Value: <span class="font-medium">${{ data.median_case.final_portfolio_value|floatformat:0|intcomma }}</span></p>
                        <p class="text-gray-700 dark:text-gray-300">Avg Return: <span class="font-medium">{{ data.median_case.average_return|floatformat:1 }}%</span></p>
                    </div>
                    <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">Click for year-by-year details</p>
                </a>
                <!-- Worst Case -->
                <a href="{% url 'historical-period-detail' scenario.pk data.worst_case.start_year %}" class="block bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border border-red-200 dark:border-red-800 hover:shadow-lg hover:border-red-400 dark:hover:border-red-600 transition-all">
                    <h3 class="font-semibold text-red-800 dark:text-red-300 mb-2">Worst Case ({{ data.worst_case.start_year }}) →</h3>
                    <div class="space-y-1 text-sm">
                        {% if data.worst_case.final_portfolio_value > 0 %}
                            <p class="text-gray-700 dark:text-gray-300">Final Value: <span class="font-medium">${{ data.worst_case.final_portfolio_value|floatformat:0|intcomma }}</span></p>
                        {% else %}
                            <p class="text-gray-700 dark:text-gray-300">Lasted: <span class="font-medium text-red-600">{{ data.worst_case.years_lasted }} years</span></p>
                        {% endif %}
                        <p class="text-gray-700 dark:text-gray-300">Avg Return: <span class="font-medium">{{ data.worst_case.average_return|floatformat:1 }}%</span></p>
                    </div>
                    <p class="text-xs text-red-600 dark:text-red-400 mt-2">Click for year-by-year details</p>
                </a>
            </div>

            <!-- Percentile Chart -->
            <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg mb-8">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Portfolio Value Confidence Bands</h3>
                <canvas id="historicalChart" height="100"></canvas>
            </div>

            <!-- Notable Periods -->
            {% if data.notable_periods %}
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Notable Historical Periods</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Period</th>
                                <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Start Year</th>
                                <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Description</th>
                                <th class="px-4 py-2 text-center text-gray-700 dark:text-gray-300">Result</th>
                                <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Final Value</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            {% for period in data.notable_periods %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer" onclick="window.location='{% url 'historical-period-detail' scenario.pk period.start_year %}'">
                                <td class="px-4 py-2 font-medium text-gray-900 dark:text-white">{{ period.period_name }}</td>
                                <td class="px-4 py-2 text-indigo-600 dark:text-indigo-400 hover:underline">{{ period.start_year }} →</td>
                                <td class="px-4 py-2 text-gray-600 dark:text-gray-400">{{ period.description }}</td>
                                <td class="px-4 py-2 text-center">
                                    {% if period.success %}
                                        <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-full text-xs">Success</span>
                                    {% else %}
                                        <span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded-full text-xs">{{ period.years_lasted }} yrs</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-2 text-right text-gray-900 dark:text-white">${{ period.final_portfolio_value|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Vulnerable Periods -->
            {% if data.vulnerable_periods %}
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-red-600 dark:text-red-400 mb-4">Vulnerable Periods (Failed Scenarios)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-red-50 dark:bg-red-900/20">
                            <tr>
                                <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Start Year</th>
                                <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Years Lasted</th>
                                <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Shortfall</th>
                                <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Reason</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            {% for period in data.vulnerable_periods %}
                            <tr class="hover:bg-red-50 dark:hover:bg-red-900/10 cursor-pointer" onclick="window.location='{% url 'historical-period-detail' scenario.pk period.start_year %}'">
                                <td class="px-4 py-2 font-medium text-indigo-600 dark:text-indigo-400 hover:underline">{{ period.start_year }} →</td>
                                <td class="px-4 py-2 text-gray-600 dark:text-gray-400">{{ period.years_lasted }} years</td>
                                <td class="px-4 py-2 text-red-600 dark:text-red-400">{{ period.shortfall_years }} years short</td>
                                <td class="px-4 py-2 text-gray-600 dark:text-gray-400">{{ period.reason }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Final Value Percentiles -->
            <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Final Portfolio Value Distribution</h3>
                <div class="grid grid-cols-2 md:grid-cols-7 gap-4 text-center">
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">5th %ile</p>
                        <p class="font-semibold text-gray-900 dark:text-white">${{ data.final_value_percentiles.p5|floatformat:0|intcomma }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">10th %ile</p>
                        <p class="font-semibold text-gray-900 dark:text-white">${{ data.final_value_percentiles.p10|floatformat:0|intcomma }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">25th %ile</p>
                        <p class="font-semibold text-gray-900 dark:text-white">${{ data.final_value_percentiles.p25|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="bg-indigo-100 dark:bg-indigo-900/30 rounded p-2">
                        <p class="text-xs text-indigo-600 dark:text-indigo-400">Median</p>
                        <p class="font-bold text-indigo-700 dark:text-indigo-300">${{ data.final_value_percentiles.p50|floatformat:0|intcomma }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">75th %ile</p>
                        <p class="font-semibold text-gray-900 dark:text-white">${{ data.final_value_percentiles.p75|floatformat:0|intcomma }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">90th %ile</p>
                        <p class="font-semibold text-gray-900 dark:text-white">${{ data.final_value_percentiles.p90|floatformat:0|intcomma }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 dark:text-gray-400">95th %ile</p>
                        <p class="font-semibold text-gray-900 dark:text-white">${{ data.final_value_percentiles.p95|floatformat:0|intcomma }}</p>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            const yearlyData = {{ data.yearly_percentiles|safe }};
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#ffffff' : '#374151';  // White for dark mode, gray-700 for light
            const gridColor = isDark ? 'rgba(156, 163, 175, 0.3)' : 'rgba(209, 213, 219, 0.5)';  // Brighter grid in dark mode

            const labels = yearlyData.map(d => d.age);

            new Chart(document.getElementById('historicalChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '95th Percentile',
                            data: yearlyData.map(d => d.p95),
                            borderColor: 'rgba(34, 197, 94, 0.5)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: '75th Percentile',
                            data: yearlyData.map(d => d.p75),
                            borderColor: 'rgba(34, 197, 94, 0.8)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: '+1'
                        },
                        {
                            label: 'Median (50th)',
                            data: yearlyData.map(d => d.p50),
                            borderColor: '#4f46e5',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: '25th Percentile',
                            data: yearlyData.map(d => d.p25),
                            borderColor: 'rgba(239, 68, 68, 0.8)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: '-1'
                        },
                        {
                            label: '5th Percentile',
                            data: yearlyData.map(d => d.p5),
                            borderColor: 'rgba(239, 68, 68, 0.5)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: textColor, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Age', color: textColor },
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        y: {
                            title: { display: true, text: 'Portfolio Value ($)', color: textColor },
                            grid: { color: gridColor },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                                    if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        </script>
        {% endwith %}
    {% else %}
        <!-- No results yet - show run button -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">Historical Analysis</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">
                Test your retirement strategy against every historical period from 1960 to present.
                This analysis will show how your portfolio would have performed if you had retired in any given year.
            </p>
            <form method="post" action="{% url 'run-historical-calculation' scenario.id %}">
                {% csrf_token %}
                <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
                    Run Historical Analysis
                </button>
            </form>
        </div>
    {% endif %}
{% endif %}

<div class="flex space-x-4">
    {% if scenario.calculator_type == 'monte_carlo' %}
        <a href="{% url 'scenario-monte-carlo-edit' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
            Edit Scenario
        </a>
    {% elif scenario.calculator_type == 'bucketed_withdrawal' %}
        <a href="{% url 'scenario-bucketed-edit' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
            Edit Scenario
        </a>
    {% elif scenario.calculator_type == 'historical' %}
        <a href="{% url 'scenario-historical-edit' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
            Edit Scenario
        </a>
        {% if scenario.result and scenario.result.status == 'completed' %}
        <form method="post" action="{% url 'run-historical-calculation' scenario.id %}" class="inline">
            {% csrf_token %}
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                Re-run Analysis
            </button>
        </form>
        {% endif %}
    {% else %}
        <a href="{% url 'scenario-edit' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
            Edit Scenario
        </a>
    {% endif %}

    <!-- Sensitivity Analysis Link (only for scenarios with completed calculations) -->
    {% if scenario.result and scenario.result.status == 'completed' %}
        {% if scenario.calculator_type == '4_percent' or scenario.calculator_type == '4_7_percent' or scenario.calculator_type == 'monte_carlo' %}
        <a href="{% url 'scenario-sensitivity' scenario.id %}" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
            Sensitivity Analysis
        </a>
        {% endif %}
    {% endif %}

    <!-- Tax Analysis Link (for tax-aware withdrawal strategies) -->
    <a href="{% url 'withdrawal-strategy' scenario.id %}" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition duration-200">
        Tax Analysis
    </a>

    <a href="{% url 'scenarios' %}" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition duration-200">
        Back to Scenarios
    </a>
</div>
{% endblock %}
