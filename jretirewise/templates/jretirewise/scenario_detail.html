{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ scenario.name }} - jRetireWise{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">{{ scenario.name }}</h1>
    <p class="text-gray-600 mt-2">{{ scenario.description }}</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
    <!-- Scenario Stats -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-gray-500 text-sm font-medium">Calculator</h3>
        <p class="text-2xl font-bold text-gray-900 mt-2">{{ scenario.get_calculator_type_display }}</p>
    </div>

    {% if scenario.result %}
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-gray-500 text-sm font-medium">Status</h3>
            <p class="text-2xl font-bold mt-2">
                {% if scenario.result.status == 'completed' %}
                    <span class="text-green-600">✓ Completed</span>
                {% elif scenario.result.status == 'pending' %}
                    <span class="text-yellow-600">⏳ Running</span>
                {% else %}
                    <span class="text-red-600">✗ Failed</span>
                {% endif %}
            </p>
        </div>

        {% if scenario.result.status == 'failed' %}
            <div class="col-span-2 bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm font-medium">Error</h3>
                <p class="text-gray-900 mt-2">{{ scenario.result.error_message }}</p>
            </div>
        {% else %}
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm font-medium">Success Rate</h3>
                <p class="text-2xl font-bold text-gray-900 mt-2">
                    {% if scenario.result.result_data.calculation.success_rate is not None %}
                        {{ scenario.result.result_data.calculation.success_rate|floatformat:0 }}%
                    {% else %}
                        —
                    {% endif %}
                </p>
            </div>
        {% endif %}

    {% endif %}
</div>

<!-- Scenario Summary -->
{% if scenario.result and scenario.result.result_data.calculation.projections %}
<div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 mb-6">Scenario Summary</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <p class="text-gray-600 text-sm font-medium">Initial Portfolio Balance</p>
            <p class="text-2xl font-bold text-gray-900 mt-2">
                ${{ scenario.result.result_data.calculation.projections.0.portfolio_value|floatformat:0|intcomma }}
            </p>
        </div>
        <div>
            <p class="text-gray-600 text-sm font-medium">Final Portfolio Balance</p>
            <p class="text-2xl font-bold text-gray-900 mt-2">
                {% with scenario.result.result_data.calculation.projections|last as last_projection %}
                    ${{ last_projection.portfolio_value|floatformat:0|intcomma }}
                {% endwith %}
            </p>
        </div>
        <div>
            <p class="text-gray-600 text-sm font-medium">Initial Annual Withdrawal</p>
            <p class="text-2xl font-bold text-gray-900 mt-2">
                ${{ scenario.result.result_data.calculation.projections.0.annual_withdrawal|floatformat:0|intcomma }}
            </p>
        </div>
        <div>
            <p class="text-gray-600 text-sm font-medium">Final Annual Withdrawal</p>
            <p class="text-2xl font-bold text-gray-900 mt-2">
                {% with scenario.result.result_data.calculation.projections|last as last_projection %}
                    ${{ last_projection.annual_withdrawal|floatformat:0|intcomma }}
                {% endwith %}
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- Chart -->
{% if scenario.result and scenario.result.result_data.calculation.projections %}
<div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 mb-6">Portfolio Projection</h2>
    <div style="position: relative; height: 400px;">
        <canvas id="projectionChart"></canvas>
    </div>
</div>

<script>
    const ctx = document.getElementById('projectionChart').getContext('2d');
    const projections = {{ scenario.result.result_data.calculation.projections|safe }};

    const ages = projections.map(p => p.age);
    const portfolioValues = projections.map(p => p.portfolio_value);
    const withdrawals = projections.map(p => p.annual_withdrawal);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ages,
            datasets: [
                {
                    label: 'Portfolio Value',
                    data: portfolioValues,
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Annual Withdrawal',
                    data: withdrawals,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Portfolio Value ($)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Annual Withdrawal ($)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
</script>
{% endif %}

<!-- Scenario Details -->
<div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 mb-6">Scenario Parameters</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- User-provided parameters -->
        {% for key, value in scenario.parameters.items %}
        <div>
            <label class="block text-sm font-medium text-gray-700">
                {% if key == 'portfolio_value' %}Portfolio Value
                {% elif key == 'current_age' %}Current Age
                {% elif key == 'retirement_age' %}Retirement Age
                {% elif key == 'life_expectancy' %}Life Expectancy
                {% elif key == 'annual_spending' %}Annual Spending
                {% elif key == 'annual_return_rate' %}Annual Return Rate
                {% elif key == 'annual_return' %}Annual Return Rate
                {% elif key == 'inflation_rate' %}Inflation Rate
                {% else %}{{ key|title }}
                {% endif %}
            </label>
            <p class="mt-1 text-lg text-gray-900">
                {% if key in 'annual_return_rate,inflation_rate,annual_return' %}
                    {{ value|floatformat:1 }}%
                {% elif key in 'current_age,retirement_age' %}
                    {{ value|floatformat:1 }}
                {% elif key in 'portfolio_value,annual_spending' %}
                    ${{ value|floatformat:0|intcomma }}
                {% else %}
                    {{ value }}
                {% endif %}
            </p>
            <p class="text-xs text-gray-500 mt-1">User-provided</p>
        </div>
        {% endfor %}

        <!-- Default values that were used -->
        {% if scenario.result.result_data.defaults_used %}
            {% for key, value in scenario.result.result_data.defaults_used.items %}
                {% if value is not None %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        {% if key == 'portfolio_value' %}Portfolio Value
                        {% elif key == 'current_age' %}Current Age
                        {% elif key == 'retirement_age' %}Retirement Age
                        {% elif key == 'life_expectancy' %}Life Expectancy
                        {% elif key == 'annual_spending' %}Annual Spending
                        {% elif key == 'annual_return_rate' %}Annual Return Rate
                        {% elif key == 'annual_return' %}Annual Return Rate
                        {% elif key == 'inflation_rate' %}Inflation Rate
                        {% else %}{{ key|title }}
                        {% endif %}
                    </label>
                    <p class="mt-1 text-lg text-gray-900">
                        {% if key in 'annual_return_rate,inflation_rate,annual_return' %}
                            {{ value|floatformat:1 }}%
                        {% elif key in 'current_age,retirement_age' %}
                            {{ value|floatformat:1 }}
                        {% elif key in 'portfolio_value,annual_spending' %}
                            ${{ value|floatformat:0|intcomma }}
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </p>
                    <p class="text-xs text-gray-500 mt-1">Default value</p>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    <!-- Display note if using defaults -->
    {% if scenario.result.result_data.defaults_used %}
        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
            <p class="text-sm text-blue-700">
                <span class="font-medium">ℹ Note:</span> Some parameters were not specified and were filled in with default values from your financial profile.
            </p>
        </div>
    {% endif %}
</div>

<!-- Actions -->
<div class="flex space-x-4">
    <a href="{% url 'scenario-edit' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
        Edit
    </a>
    <a href="{% url 'dashboard' %}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
        Back to Dashboard
    </a>
</div>
{% endblock %}
