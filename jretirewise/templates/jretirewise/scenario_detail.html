{% extends "base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}{{ scenario.name }} - jRetireWise{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ scenario.name }}</h1>
    <p class="text-gray-600 dark:text-gray-400 mt-2">{{ scenario.description }}</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
    <!-- Scenario Stats -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Calculator</h3>
        <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">{{ scenario.get_calculator_type_display }}</p>
    </div>

    {% if scenario.result %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Status</h3>
            <p class="text-2xl font-bold mt-2">
                {% if scenario.result.status == 'completed' %}
                    <span class="text-green-600 dark:text-green-400">Completed</span>
                {% elif scenario.result.status == 'pending' %}
                    <span class="text-yellow-600 dark:text-yellow-400">Running</span>
                {% else %}
                    <span class="text-red-600 dark:text-red-400">Failed</span>
                {% endif %}
            </p>
        </div>

        {% if scenario.result.status == 'failed' %}
            <div class="col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Error</h3>
                <p class="text-gray-900 dark:text-white mt-2">{{ scenario.result.error_message }}</p>
            </div>
        {% else %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Success Rate</h3>
                <p class="text-2xl font-bold mt-2">
                    {% if scenario.result.result_data.calculation.success_rate is not None %}
                        {% with scenario.result.result_data.calculation.success_rate as rate %}
                            <span class="{% if rate >= 90 %}text-green-600 dark:text-green-400{% elif rate >= 75 %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                {{ rate|floatformat:1 }}%
                            </span>
                        {% endwith %}
                    {% elif scenario.result.result_data.summary.success_rate is not None %}
                        {% with scenario.result.result_data.summary.success_rate as rate %}
                            <span class="{% if rate >= 90 %}text-green-600 dark:text-green-400{% elif rate >= 75 %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                                {{ rate|floatformat:1 }}%
                            </span>
                        {% endwith %}
                    {% else %}
                        <span class="text-gray-900 dark:text-white">—</span>
                    {% endif %}
                </p>
            </div>
        {% endif %}

    {% endif %}
</div>

<!-- Enhanced Monte Carlo Results -->
{% if scenario.calculator_type == 'monte_carlo' and scenario.result and scenario.result.status == 'completed' %}
{% with scenario.result.result_data.calculation as calc %}


<!-- Monte Carlo Results Summary -->
{% if calc.yearly_percentiles %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 mb-6">Results</h2>

    <!-- Key Results -->
    <div class="space-y-3 mb-8">
        {% if calc.mode == 'find_withdrawal' %}
        <!-- Find Withdrawal Mode Results -->
        <div class="flex items-baseline">
            <span class="text-gray-600 dark:text-gray-400 mr-2">Target Success Rate:</span>
            <span class="text-xl font-bold text-indigo-500">{{ calc.achieved_success_rate|floatformat:1 }}%</span>
        </div>
        <div class="flex items-baseline flex-wrap">
            <span class="text-gray-600 dark:text-gray-400 mr-2">Safe Withdrawal:</span>
            <span class="text-xl font-bold text-green-600">${{ calc.safe_withdrawal_annual|floatformat:0|intcomma }}</span>
            {% if calc.four_percent_comparison %}
            <span class="text-gray-500 dark:text-gray-400 mx-2">as compared to</span>
            <span class="text-xl font-bold text-green-600">${{ calc.four_percent_comparison.withdrawal_annual|floatformat:0|intcomma }}</span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">at the 4 percent rule</span>
            {% endif %}
        </div>
        {% else %}
        <!-- Evaluate Success Mode Results -->
        <div class="flex items-baseline">
            <span class="text-gray-600 dark:text-gray-400 mr-2">Monte Carlo Success Rate:</span>
            <span class="text-xl font-bold {% if calc.success_rate >= 90 %}text-green-600{% elif calc.success_rate >= 75 %}text-yellow-500{% else %}text-red-500{% endif %}">{{ calc.success_rate|floatformat:1 }}%</span>
        </div>
        <div class="flex items-baseline flex-wrap">
            <span class="text-gray-600 dark:text-gray-400 mr-2">Withdrawal:</span>
            <span class="text-xl font-bold text-green-600">${{ calc.withdrawal_annual|floatformat:0|intcomma }}</span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">({{ calc.withdrawal_rate|floatformat:2 }}% of portfolio)</span>
            {% if calc.four_percent_comparison %}
            <span class="text-gray-500 dark:text-gray-400 mx-2">as compared to</span>
            <span class="text-xl font-bold text-green-600">${{ calc.four_percent_comparison.withdrawal_annual|floatformat:0|intcomma }}</span>
            <span class="text-gray-500 dark:text-gray-400 ml-2">at the 4 percent rule</span>
            {% endif %}
        </div>
        {% endif %}

        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-baseline mb-2">
                <span class="text-gray-600 dark:text-gray-400 mr-2">Ending Fixed Rate:</span>
                <span class="text-lg font-semibold text-green-600">
                    {% with calc.constant_return_trajectory|last as last_const %}
                        ${{ last_const.portfolio_value|floatformat:0|intcomma }}
                    {% endwith %}
                </span>
            </div>
            <div class="flex items-baseline mb-2">
                <span class="text-gray-600 dark:text-gray-400 mr-2">Ending Median Rate:</span>
                <span class="text-lg font-semibold text-indigo-400">${{ calc.final_value_percentiles.p50|floatformat:0|intcomma }}</span>
            </div>
            <div class="flex items-baseline">
                <span class="text-gray-600 dark:text-gray-400 mr-2">Ending Target Rate:</span>
                <span class="text-lg font-semibold text-red-400">${{ calc.final_value_percentiles.p10|floatformat:0|intcomma }}</span>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div style="position: relative; height: 400px;">
        <canvas id="mcChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
(function() {
    const ctx = document.getElementById('mcChart').getContext('2d');
    const yearlyPercentiles = {{ calc.yearly_percentiles|safe }};
    const constantReturn = {{ calc.constant_return_trajectory|safe|default:'[]' }};
    const ssStartAge = {{ calc.parameters.social_security_start_age|default:'null' }};
    const ssAnnual = {{ calc.parameters.social_security_annual|default:0 }};
    const retirementAge = {{ calc.parameters.retirement_age }};

    const ages = yearlyPercentiles.map(p => p.age);
    const p10 = yearlyPercentiles.map(p => p.p10);  // Target success rate (~90% success)
    const p50 = yearlyPercentiles.map(p => p.p50);  // Median
    const constantValues = constantReturn.map(c => c.portfolio_value);

    // Find index where SS starts (for annotation)
    const ssStartIndex = ssStartAge && ssAnnual > 0 ? ages.indexOf(ssStartAge) : -1;

    // Build annotations if SS is present
    const annotations = {};
    if (ssStartIndex >= 0 && ssAnnual > 0) {
        annotations.ssLine = {
            type: 'line',
            xMin: ssStartIndex,
            xMax: ssStartIndex,
            borderColor: 'rgba(59, 130, 246, 0.7)',
            borderWidth: 2,
            borderDash: [6, 4],
            label: {
                display: true,
                content: 'SS Starts',
                position: 'start',
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                color: 'white',
                font: { size: 11 }
            }
        };
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ages,
            datasets: [
                {
                    label: 'Constant Return',
                    data: constantValues,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: true,
                    order: 3
                },
                {
                    label: 'Random Returns: Median',
                    data: p50,
                    borderColor: 'rgb(167, 139, 250)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    order: 2
                },
                {
                    label: 'Random Returns: Target Success',
                    data: p10,
                    borderColor: 'rgb(251, 113, 133)',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Age',
                        color: '#9CA3AF'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.2)'
                    },
                    ticks: {
                        color: '#9CA3AF'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Portfolio Value',
                        color: '#9CA3AF'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.2)'
                    },
                    ticks: {
                        color: '#9CA3AF',
                        callback: function(value) {
                            if (value >= 1000000) {
                                return '$' + (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                            return '$' + value;
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        color: '#9CA3AF',
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                        }
                    }
                },
                annotation: {
                    annotations: annotations
                }
            }
        }
    });
})();
</script>
{% endif %}

<!-- Monte Carlo Parameters -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Simulation Parameters</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Portfolio Value</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">${{ calc.parameters.portfolio_value|floatformat:0|intcomma }}</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Retirement Period</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.years_in_retirement }} years</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Expected Return</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.mean_return|floatformat:1 }}%</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Volatility (Std Dev)</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.return_std_dev|floatformat:1 }}%</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Inflation Rate</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.inflation_rate|floatformat:1 }}%</p>
        </div>
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Simulations</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ calc.parameters.num_simulations|intcomma }}</p>
        </div>
        {% if calc.parameters.social_security_annual and calc.parameters.social_security_annual > 0 %}
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Social Security</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">${{ calc.parameters.social_security_annual|floatformat:0|intcomma }}/yr</p>
            <p class="text-xs text-gray-400">Starting at age {{ calc.parameters.social_security_start_age }}</p>
        </div>
        {% endif %}
        {% if calc.parameters.pension_annual and calc.parameters.pension_annual > 0 %}
        <div>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Pension</p>
            <p class="text-lg font-semibold text-gray-900 dark:text-white">${{ calc.parameters.pension_annual|floatformat:0|intcomma }}/yr</p>
        </div>
        {% endif %}
    </div>
</div>
{% endwith %}
{% endif %}

<!-- Standard Scenario Summary (for non-Monte Carlo) -->
{% if scenario.calculator_type != 'monte_carlo' and scenario.result and scenario.result.result_data.calculation.projections %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Scenario Summary</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Initial Portfolio Balance</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                ${{ scenario.result.result_data.calculation.projections.0.portfolio_value|floatformat:0|intcomma }}
            </p>
        </div>
        <div>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Final Portfolio Balance</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                {% with scenario.result.result_data.calculation.projections|last as last_projection %}
                    ${{ last_projection.portfolio_value|floatformat:0|intcomma }}
                {% endwith %}
            </p>
        </div>
        <div>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Initial Annual Withdrawal</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                ${{ scenario.result.result_data.calculation.projections.0.annual_withdrawal|floatformat:0|intcomma }}
            </p>
        </div>
        <div>
            <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Final Annual Withdrawal</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                {% with scenario.result.result_data.calculation.projections|last as last_projection %}
                    ${{ last_projection.annual_withdrawal|floatformat:0|intcomma }}
                {% endwith %}
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- Chart for non-Monte Carlo scenarios -->
{% if scenario.calculator_type != 'monte_carlo' and scenario.result and scenario.result.result_data.calculation.projections %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Portfolio Projection</h2>
    <div style="position: relative; height: 400px;">
        <canvas id="projectionChart"></canvas>
    </div>
</div>

<script>
(function() {
    const ctx = document.getElementById('projectionChart').getContext('2d');
    const projections = {{ scenario.result.result_data.calculation.projections|safe }};

    const ages = projections.map(p => p.age);
    const portfolioValues = projections.map(p => p.portfolio_value);
    const withdrawals = projections.map(p => p.annual_withdrawal);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ages,
            datasets: [
                {
                    label: 'Portfolio Value',
                    data: portfolioValues,
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Annual Withdrawal',
                    data: withdrawals,
                    borderColor: '#EF4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Portfolio Value ($)',
                        color: '#6B7280'
                    },
                    ticks: {
                        color: '#6B7280'
                    },
                    grid: {
                        color: 'rgba(107, 114, 128, 0.1)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Annual Withdrawal ($)',
                        color: '#6B7280'
                    },
                    ticks: {
                        color: '#6B7280'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#6B7280'
                    }
                }
            }
        }
    });
})();
</script>
{% endif %}

<!-- Scenario Details (for non-Monte Carlo - Monte Carlo has its own parameters section) -->
{% if scenario.calculator_type != 'monte_carlo' %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6">Scenario Parameters</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- User-provided parameters -->
        {% for key, value in scenario.parameters.items %}
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                {% if key == 'portfolio_value' %}Portfolio Value
                {% elif key == 'current_age' %}Current Age
                {% elif key == 'retirement_age' %}Retirement Age
                {% elif key == 'life_expectancy' %}Life Expectancy
                {% elif key == 'annual_spending' %}Annual Spending
                {% elif key == 'annual_return_rate' %}Annual Return Rate
                {% elif key == 'annual_return' %}Annual Return Rate
                {% elif key == 'inflation_rate' %}Inflation Rate
                {% else %}{{ key|title }}
                {% endif %}
            </label>
            <p class="mt-1 text-lg text-gray-900 dark:text-white">
                {% if key in 'annual_return_rate,inflation_rate,annual_return' %}
                    {{ value|floatformat:1 }}%
                {% elif key in 'current_age,retirement_age' %}
                    {{ value|floatformat:1 }}
                {% elif key in 'portfolio_value,annual_spending' %}
                    ${{ value|floatformat:0|intcomma }}
                {% else %}
                    {{ value }}
                {% endif %}
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">User-provided</p>
        </div>
        {% endfor %}

        <!-- Default values that were used -->
        {% if scenario.result.result_data.defaults_used %}
            {% for key, value in scenario.result.result_data.defaults_used.items %}
                {% if value is not None %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        {% if key == 'portfolio_value' %}Portfolio Value
                        {% elif key == 'current_age' %}Current Age
                        {% elif key == 'retirement_age' %}Retirement Age
                        {% elif key == 'life_expectancy' %}Life Expectancy
                        {% elif key == 'annual_spending' %}Annual Spending
                        {% elif key == 'annual_return_rate' %}Annual Return Rate
                        {% elif key == 'annual_return' %}Annual Return Rate
                        {% elif key == 'inflation_rate' %}Inflation Rate
                        {% else %}{{ key|title }}
                        {% endif %}
                    </label>
                    <p class="mt-1 text-lg text-gray-900 dark:text-white">
                        {% if key in 'annual_return_rate,inflation_rate,annual_return' %}
                            {{ value|floatformat:1 }}%
                        {% elif key in 'current_age,retirement_age' %}
                            {{ value|floatformat:1 }}
                        {% elif key in 'portfolio_value,annual_spending' %}
                            ${{ value|floatformat:0|intcomma }}
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Default value</p>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    <!-- Display note if using defaults -->
    {% if scenario.result.result_data.defaults_used %}
        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded">
            <p class="text-sm text-blue-700 dark:text-blue-300">
                <span class="font-medium">Note:</span> Some parameters were not specified and were filled in with default values from your financial profile.
            </p>
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Actions -->
<!-- Bucketed Withdrawal Results -->
{% if scenario.calculator_type == 'bucketed_withdrawal' %}
    {% if scenario.withdrawal_buckets.exists %}
        {% if scenario.result and scenario.result.status == 'completed' %}
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-6">Bucketed Withdrawal Results</h2>

                <!-- Summary Stats -->
                {% with scenario.result.result_data.summary as summary %}
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Success Rate</p>
                        <p class="text-2xl font-bold {% if summary.success_rate >= 100 %}text-green-600{% else %}text-red-600{% endif %}">{{ summary.success_rate|floatformat:0 }}%</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Final Portfolio Value</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">${{ summary.final_portfolio_value|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Total Withdrawals</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">${{ summary.total_withdrawals|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Success Status</p>
                        <p class="text-2xl font-bold {% if not summary.portfolio_depleted %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if not summary.portfolio_depleted %}✓ Success{% else %}✗ Failed{% endif %}
                        </p>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-400">Years Portfolio Lasted</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ summary.total_projections }}</p>
                    </div>
                </div>
                {% endwith %}

                <!-- Year-by-Year Results Table -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Year-by-Year Projections</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Year</th>
                                    <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Age</th>
                                    <th class="px-4 py-2 text-left text-gray-700 dark:text-gray-300">Bucket</th>
                                    <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Rate</th>
                                    <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Withdrawal</th>
                                    <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Income</th>
                                    <th class="px-4 py-2 text-right text-gray-700 dark:text-gray-300">Portfolio (End)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                {% for year_result in scenario.result.bucketed_results.all|slice:":100" %}
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                        <td class="px-4 py-2 text-gray-900 dark:text-white">{{ year_result.year }}</td>
                                        <td class="px-4 py-2 text-gray-900 dark:text-white">{{ year_result.age }}</td>
                                        <td class="px-4 py-2 text-gray-900 dark:text-white font-medium">{{ year_result.bucket.bucket_name }}</td>
                                        <td class="px-4 py-2 text-right text-gray-900 dark:text-white">{{ year_result.target_rate|floatformat:1 }}%</td>
                                        <td class="px-4 py-2 text-right text-gray-900 dark:text-white">${{ year_result.actual_withdrawal|floatformat:0|intcomma }}</td>
                                        <td class="px-4 py-2 text-right text-gray-900 dark:text-white">${{ year_result.total_available_income|floatformat:0|intcomma }}</td>
                                        <td class="px-4 py-2 text-right text-gray-900 dark:text-white font-semibold">${{ year_result.portfolio_value_end|floatformat:0|intcomma }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if scenario.result.bucketed_results.all|length > 100 %}
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Showing first 100 years of {{ scenario.result.bucketed_results.all|length }} total years</p>
                    {% endif %}
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Portfolio Value Chart -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Portfolio Value Over Time</h3>
                        <canvas id="portfolioChart" height="200"></canvas>
                    </div>
                    <!-- Annual Withdrawal Chart -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Annual Withdrawal Over Time</h3>
                        <canvas id="withdrawalChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                // Use projections from result_data (already JSON)
                const bucketedData = {{ scenario.result.result_data.projections|safe }};
                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#d1d5db' : '#374151';
                const gridColor = isDark ? 'rgba(107, 114, 128, 0.3)' : 'rgba(209, 213, 219, 0.5)';

                // Prepare data for charts
                const labels = bucketedData.map(d => d.age);
                const portfolioValues = bucketedData.map(d => parseFloat(d.portfolio_value_end));
                const withdrawals = bucketedData.map(d => parseFloat(d.actual_withdrawal));

                // Portfolio Value Chart
                new Chart(document.getElementById('portfolioChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Portfolio Value',
                            data: portfolioValues,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Age', color: textColor },
                                grid: { color: gridColor },
                                ticks: { color: textColor }
                            },
                            y: {
                                title: { display: true, text: 'Portfolio Value ($)', color: textColor },
                                grid: { color: gridColor },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });

                // Annual Withdrawal Chart
                new Chart(document.getElementById('withdrawalChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Annual Withdrawal',
                            data: withdrawals,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Age', color: textColor },
                                grid: { color: gridColor },
                                ticks: { color: textColor }
                            },
                            y: {
                                title: { display: true, text: 'Annual Withdrawal ($)', color: textColor },
                                grid: { color: gridColor },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
                                        if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            </script>
        {% else %}
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 text-center">
                <p class="text-gray-600 dark:text-gray-400 mb-4">Calculation not run yet. Configure your withdrawal buckets and run the calculation to see results.</p>
                <a href="{% url 'bucket-list' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 inline-block">
                    Manage Buckets
                </a>
            </div>
        {% endif %}
    {% else %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 text-center">
            <p class="text-gray-600 dark:text-gray-400 mb-4">No withdrawal buckets configured yet. Create your first bucket to define your retirement strategy.</p>
            <a href="{% url 'bucket-create' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 inline-block">
                Create First Bucket
            </a>
        </div>
    {% endif %}
{% endif %}

<div class="flex space-x-4">
    {% if scenario.calculator_type == 'monte_carlo' %}
        <a href="{% url 'scenario-monte-carlo-edit' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
            Edit Scenario
        </a>
    {% elif scenario.calculator_type == 'bucketed_withdrawal' %}
        <a href="{% url 'scenario-bucketed-edit' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
            Edit Scenario
        </a>
    {% else %}
        <a href="{% url 'scenario-edit' scenario.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
            Edit Scenario
        </a>
    {% endif %}
    <a href="{% url 'scenarios' %}" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition duration-200">
        Back to Scenarios
    </a>
</div>
{% endblock %}
