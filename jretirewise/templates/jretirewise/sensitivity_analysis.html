{% extends "base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Sensitivity Analysis - {{ scenario.name }} - jRetireWise{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript access -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="mb-6" x-data="sensitivityAnalysis()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Sensitivity Analysis</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">{{ scenario.name }}</p>
        </div>
        <a href="{% url 'scenario-detail' scenario.id %}"
           class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            Back to Scenario
        </a>
    </div>

    {% if error %}
    <!-- Error Message -->
    <div class="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-200 px-4 py-3 rounded mb-6">
        <p class="font-bold">Error</p>
        <p>{{ error }}</p>
    </div>
    {% else %}

    <!-- Baseline Results -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Baseline Results</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Success Rate</h3>
                <p class="text-2xl font-bold mt-2">
                    <span class="{% if baseline.success_rate >= 90 %}text-green-600 dark:text-green-400{% elif baseline.success_rate >= 75 %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                        {{ baseline.success_rate|floatformat:1 }}%
                    </span>
                </p>
            </div>
            <div>
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Final Portfolio Value (Median)</h3>
                <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2">
                    ${{ baseline.final_value|floatformat:0|intcomma }}
                </p>
            </div>
        </div>
    </div>

    <!-- Parameter Adjustments -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Adjust Parameters</h2>
            <button @click="resetSliders()"
                    class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                Reset
            </button>
        </div>

        <!-- Preset Buttons -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button @click="applyPreset('conservative')"
                    class="px-4 py-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition">
                Conservative (-2% return, +10% spending)
            </button>
            <button @click="applyPreset('moderate')"
                    class="px-4 py-2 bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 rounded-lg hover:bg-yellow-200 dark:hover:bg-yellow-800 transition">
                Moderate (-1% return, +20% spending)
            </button>
            <button @click="applyPreset('aggressive')"
                    class="px-4 py-2 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-lg hover:bg-green-200 dark:hover:bg-green-800 transition">
                Aggressive (+1% return, -10% spending)
            </button>
        </div>

        <!-- Return Rate Adjustment -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <label class="text-gray-700 dark:text-gray-300 font-medium">Annual Return Rate Adjustment</label>
                <span class="text-lg font-bold text-indigo-600 dark:text-indigo-400" x-text="formatPercent(returnAdj)"></span>
            </div>
            <input type="range"
                   x-model.number="returnAdj"
                   @input="debouncedCalculate()"
                   min="-0.05"
                   max="0.05"
                   step="0.005"
                   class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>-5%</span>
                <span>0%</span>
                <span>+5%</span>
            </div>
        </div>

        <!-- Spending Adjustment -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <label class="text-gray-700 dark:text-gray-300 font-medium">Spending Adjustment</label>
                <span class="text-lg font-bold text-indigo-600 dark:text-indigo-400" x-text="formatPercent(spendingAdj)"></span>
            </div>
            <input type="range"
                   x-model.number="spendingAdj"
                   @input="debouncedCalculate()"
                   min="-0.30"
                   max="0.50"
                   step="0.05"
                   class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>-30%</span>
                <span>0%</span>
                <span>+50%</span>
            </div>
        </div>

        <!-- Inflation Adjustment -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <label class="text-gray-700 dark:text-gray-300 font-medium">Inflation Rate Adjustment</label>
                <span class="text-lg font-bold text-indigo-600 dark:text-indigo-400" x-text="formatPercent(inflationAdj)"></span>
            </div>
            <input type="range"
                   x-model.number="inflationAdj"
                   @input="debouncedCalculate()"
                   min="0"
                   max="0.04"
                   step="0.005"
                   class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer">
            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                <span>0%</span>
                <span>+2%</span>
                <span>+4%</span>
            </div>
        </div>

        <!-- Calculate Button -->
        <div class="flex gap-4">
            <button @click="calculate()"
                    :disabled="loading"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                <span x-show="!loading">Calculate</span>
                <span x-show="loading">Calculating...</span>
            </button>
            <button @click="showSaveModal = true"
                    :disabled="!results || loading"
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                Save Analysis
            </button>
        </div>
    </div>

    <!-- Results Display -->
    <div x-show="results" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Adjusted Results</h2>

        <!-- Loading Spinner -->
        <div x-show="loading" class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        </div>

        <!-- Results Grid -->
        <div x-show="!loading && results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Success Rate -->
            <div>
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Success Rate</h3>
                <p class="text-2xl font-bold mt-2" x-text="formatSuccessRate(results?.success_rate)"></p>
                <p class="text-sm mt-1" x-text="formatDelta(results?.comparison_to_baseline?.success_rate_delta, '%')"></p>
            </div>

            <!-- Final Value -->
            <div>
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Final Portfolio Value</h3>
                <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2" x-text="formatCurrency(results?.final_value)"></p>
                <p class="text-sm mt-1" x-text="formatDelta(results?.comparison_to_baseline?.final_value_delta, '$')"></p>
            </div>

            <!-- Withdrawal Amount -->
            <div>
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Annual Withdrawal</h3>
                <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2" x-text="formatCurrency(results?.withdrawal_amount)"></p>
            </div>

            <!-- Years to Depletion -->
            <div>
                <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Years to Depletion</h3>
                <p class="text-2xl font-bold text-gray-900 dark:text-white mt-2" x-text="results?.years_to_depletion || 'N/A'"></p>
            </div>
        </div>

        <!-- Execution Time -->
        <div x-show="results?.execution_time_ms" class="mt-4 text-sm text-gray-500 dark:text-gray-400">
            Calculation time: <span x-text="results?.execution_time_ms"></span>ms
        </div>
    </div>

    <!-- Tornado Chart Placeholder -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Parameter Impact Analysis</h2>
            <button @click="generateTornadoChart()"
                    :disabled="loadingTornado"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                <span x-show="!loadingTornado">Generate Tornado Chart</span>
                <span x-show="loadingTornado">Generating...</span>
            </button>
        </div>

        <!-- Loading Spinner -->
        <div x-show="loadingTornado" class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        </div>

        <!-- Tornado Chart Canvas -->
        <div x-show="tornadoData && !loadingTornado" class="mt-4">
            <canvas id="tornadoChart" class="w-full" style="height: 300px;"></canvas>

            <!-- Impact Summary Table -->
            <div class="mt-6 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-900">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Parameter</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Low Value</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">High Value</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Impact</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Range Tested</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <template x-for="item in tornadoData.tornado_data" :key="item.parameter">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white" x-text="item.parameter"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="item.low_value.toFixed(1) + '%'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="item.high_value.toFixed(1) + '%'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold" :class="{
                                    'text-red-600 dark:text-red-400': item.impact >= 20,
                                    'text-yellow-600 dark:text-yellow-400': item.impact >= 10 && item.impact < 20,
                                    'text-green-600 dark:text-green-400': item.impact < 10
                                }" x-text="item.impact.toFixed(1) + '%'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400" x-text="(item.range_tested.min * 100).toFixed(1) + '% to ' + (item.range_tested.max * 100).toFixed(1) + '%'"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Data Message -->
        <div x-show="!tornadoData && !loadingTornado" class="text-center py-8 text-gray-500 dark:text-gray-400">
            Click "Generate Tornado Chart" to analyze which parameters have the most impact on your retirement success.
        </div>
    </div>

    <!-- Saved Analyses -->
    {% if saved_analyses %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Saved Sensitivity Analyses</h2>
        <div class="space-y-4">
            {% for analysis in saved_analyses %}
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-gray-900 dark:text-white">{{ analysis.name }}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ analysis.description }}</p>
                        <div class="flex gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
                            <span>Return: {{ analysis.return_adjustment|floatformat:2 }}%</span>
                            <span>Spending: {{ analysis.spending_adjustment|floatformat:2 }}%</span>
                            <span>Inflation: {{ analysis.inflation_adjustment|floatformat:2 }}%</span>
                        </div>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">
                            Created: {{ analysis.created_at|date:"M d, Y g:i A" }}
                        </p>
                    </div>
                    <button @click="loadAnalysis({{ analysis.id }})"
                            class="px-3 py-1 text-sm bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 rounded hover:bg-indigo-200 dark:hover:bg-indigo-800 transition">
                        Load
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Save Modal -->
    <div x-show="showSaveModal"
         @click.away="showSaveModal = false"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
         style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Save Sensitivity Analysis</h3>
                <form @submit.prevent="saveAnalysis()">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                            Analysis Name
                        </label>
                        <input type="text"
                               x-model="saveName"
                               required
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                            Description (Optional)
                        </label>
                        <textarea x-model="saveDescription"
                                  rows="3"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-300 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit"
                                :disabled="loading"
                                class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:bg-gray-400 transition">
                            Save
                        </button>
                        <button type="button"
                                @click="showSaveModal = false"
                                class="flex-1 px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-400 dark:hover:bg-gray-500 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<!-- Alpine.js Component -->
<script>
function sensitivityAnalysis() {
    return {
        // State
        returnAdj: 0,
        spendingAdj: 0,
        inflationAdj: 0,
        results: null,
        loading: false,
        loadingTornado: false,
        tornadoData: null,
        tornadoChartInstance: null,
        showSaveModal: false,
        saveName: '',
        saveDescription: '',
        debounceTimer: null,

        // API Base URL
        apiBaseUrl: '{{ api_base_url }}',

        // Initialize
        init() {
            console.log('Sensitivity analysis component initialized');
        },

        // Format helpers
        formatPercent(value) {
            return (value * 100).toFixed(1) + '%';
        },

        formatCurrency(value) {
            if (!value) return '$0';
            return '$' + Math.round(value).toLocaleString();
        },

        formatSuccessRate(rate) {
            if (rate === null || rate === undefined) return 'N/A';
            const rateNum = parseFloat(rate);
            let color = 'text-gray-900 dark:text-white';
            if (rateNum >= 90) color = 'text-green-600 dark:text-green-400';
            else if (rateNum >= 75) color = 'text-yellow-600 dark:text-yellow-400';
            else color = 'text-red-600 dark:text-red-400';
            return `<span class="${color}">${rateNum.toFixed(1)}%</span>`;
        },

        formatDelta(delta, prefix = '') {
            if (delta === null || delta === undefined) return '';
            const deltaNum = parseFloat(delta);
            const color = deltaNum >= 0 ? 'text-green-600' : 'text-red-600';
            const sign = deltaNum >= 0 ? '+' : '';
            if (prefix === '$') {
                return `<span class="${color}">${sign}${prefix}${Math.round(deltaNum).toLocaleString()}</span>`;
            } else {
                return `<span class="${color}">${sign}${deltaNum.toFixed(1)}${prefix}</span>`;
            }
        },

        // Debounced calculate
        debouncedCalculate() {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                this.calculate();
            }, 1000);
        },

        // Calculate with adjustments
        async calculate() {
            this.loading = true;
            try {
                const response = await fetch(`${this.apiBaseUrl}/calculate/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken(),
                    },
                    body: JSON.stringify({
                        return_adjustment: this.returnAdj,
                        spending_adjustment: this.spendingAdj,
                        inflation_adjustment: this.inflationAdj,
                    }),
                });

                if (!response.ok) {
                    throw new Error('Calculation failed');
                }

                this.results = await response.json();
            } catch (error) {
                console.error('Error calculating:', error);
                alert('Failed to calculate sensitivity analysis. Please try again.');
            } finally {
                this.loading = false;
            }
        },

        // Generate tornado chart
        async generateTornadoChart() {
            this.loadingTornado = true;
            try {
                const response = await fetch(`${this.apiBaseUrl}/tornado/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken(),
                    },
                    body: JSON.stringify({}), // Use default ranges
                });

                if (!response.ok) {
                    throw new Error('Tornado chart generation failed');
                }

                this.tornadoData = await response.json();
                // Render the chart
                this.$nextTick(() => {
                    this.renderTornadoChart();
                });
            } catch (error) {
                console.error('Error generating tornado chart:', error);
                alert('Failed to generate tornado chart. Please try again.');
            } finally {
                this.loadingTornado = false;
            }
        },

        // Render tornado chart with Chart.js
        renderTornadoChart() {
            if (!this.tornadoData || !this.tornadoData.tornado_data) {
                console.error('No tornado data available');
                return;
            }

            // Destroy existing chart if it exists
            if (this.tornadoChartInstance) {
                this.tornadoChartInstance.destroy();
            }

            const canvas = document.getElementById('tornadoChart');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }

            const ctx = canvas.getContext('2d');
            const tornadoItems = this.tornadoData.tornado_data;

            // Prepare data for Chart.js
            const labels = tornadoItems.map(item => item.parameter);
            const lowValues = tornadoItems.map(item => item.low_value);
            const highValues = tornadoItems.map(item => item.high_value);
            const impacts = tornadoItems.map(item => item.impact);

            // Create gradient colors based on impact
            const colors = impacts.map(impact => {
                if (impact >= 20) return 'rgba(220, 38, 38, 0.7)'; // Red for high impact
                if (impact >= 10) return 'rgba(245, 158, 11, 0.7)'; // Orange for medium impact
                return 'rgba(34, 197, 94, 0.7)'; // Green for low impact
            });

            this.tornadoChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Low Value',
                            data: lowValues,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                        },
                        {
                            label: 'High Value',
                            data: highValues,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.7', '1')),
                            borderWidth: 1,
                        }
                    ]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Parameter Impact Analysis (Tornado Chart)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataIndex = context.dataIndex;
                                    const item = tornadoItems[dataIndex];
                                    const label = context.dataset.label;
                                    const value = context.parsed.x.toFixed(1);

                                    let lines = [`${label}: ${value}%`];

                                    if (context.datasetIndex === 1) {
                                        lines.push(`Impact: ${item.impact.toFixed(1)}% (${item.impact_percent.toFixed(1)}% change)`);
                                        lines.push(`Range tested: ${(item.range_tested.min * 100).toFixed(1)}% to ${(item.range_tested.max * 100).toFixed(1)}%`);
                                    }

                                    return lines;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Success Rate (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Parameter'
                            }
                        }
                    }
                }
            });

            console.log('Tornado chart rendered successfully');
        },

        // Save analysis
        async saveAnalysis() {
            if (!this.saveName.trim()) {
                alert('Please enter a name for this analysis');
                return;
            }

            this.loading = true;
            try {
                const response = await fetch(`${this.apiBaseUrl}/save/`, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken(),
                    },
                    body: JSON.stringify({
                        name: this.saveName,
                        description: this.saveDescription,
                        return_adjustment: this.returnAdj,
                        spending_adjustment: this.spendingAdj,
                        inflation_adjustment: this.inflationAdj,
                        result_data: this.results,
                    }),
                });

                if (!response.ok) {
                    throw new Error('Save failed');
                }

                alert('Analysis saved successfully!');
                this.showSaveModal = false;
                this.saveName = '';
                this.saveDescription = '';

                // Reload page to show new saved analysis
                window.location.reload();
            } catch (error) {
                console.error('Error saving analysis:', error);
                alert('Failed to save analysis. Please try again.');
            } finally {
                this.loading = false;
            }
        },

        // Load saved analysis
        async loadAnalysis(analysisId) {
            try {
                const response = await fetch(`${this.apiBaseUrl}/scenarios/${analysisId}/`, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken(),
                    },
                });

                if (!response.ok) {
                    throw new Error('Load failed');
                }

                const analysis = await response.json();

                // Set adjustments
                this.returnAdj = analysis.return_adjustment;
                this.spendingAdj = analysis.spending_adjustment;
                this.inflationAdj = analysis.inflation_adjustment;

                // Set results if available
                if (analysis.result_data) {
                    this.results = analysis.result_data;
                }
            } catch (error) {
                console.error('Error loading analysis:', error);
                alert('Failed to load analysis. Please try again.');
            }
        },

        // Apply presets
        applyPreset(preset) {
            switch(preset) {
                case 'conservative':
                    this.returnAdj = -0.02;
                    this.spendingAdj = 0.10;
                    this.inflationAdj = 0.01;
                    break;
                case 'moderate':
                    this.returnAdj = -0.01;
                    this.spendingAdj = 0.20;
                    this.inflationAdj = 0.01;
                    break;
                case 'aggressive':
                    this.returnAdj = 0.01;
                    this.spendingAdj = -0.10;
                    this.inflationAdj = 0.00;
                    break;
            }
            this.calculate();
        },

        // Reset sliders
        resetSliders() {
            this.returnAdj = 0;
            this.spendingAdj = 0;
            this.inflationAdj = 0;
            this.results = null;
        },

        // Get CSRF token - try form field first, then cookie
        getCsrfToken() {
            // Try getting from hidden input field first (most reliable)
            const tokenField = document.querySelector('[name=csrfmiddlewaretoken]');
            if (tokenField && tokenField.value) {
                return tokenField.value;
            }

            // Fall back to cookie
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === 'csrftoken=') {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue || '';
        },
    };
}
</script>

{% endblock %}
