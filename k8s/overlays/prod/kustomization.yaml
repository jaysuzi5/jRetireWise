apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: jretirewise

bases:
- ../../base

resources:
- ingress.yaml

# Production replicas - scaled for 1-3 users
replicas:
- name: jretirewise-web
  count: 2
- name: postgres
  count: 1

# ConfigMap overrides for production
configMapGenerator:
- name: jretirewise-config
  behavior: merge
  literals:
  - DEBUG=false
  - ALLOWED_HOSTS=jaycurtis.org,192.168.86.229,localhost,127.0.0.1
  - SECURE_SSL_REDIRECT=false
  - SESSION_COOKIE_SECURE=false
  - CSRF_COOKIE_SECURE=false
  - CSRF_TRUSTED_ORIGINS=http://192.168.86.229,http://jaycurtis.org,https://jaycurtis.org,https://jretirewise.jaycurtis.org
  - DATABASE_HOST=prod-jretirewise-postgres-service.jretirewise.svc.cluster.local
  - REDIS_URL=redis://prod-jretirewise-redis-service.jretirewise.svc.cluster.local:6379/0
  - CELERY_BROKER_URL=redis://prod-jretirewise-redis-service.jretirewise.svc.cluster.local:6379/0
  - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector-collector.monitoring.svc.cluster.local:4317
  - OTEL_SERVICE_NAME=jretirewise
  - OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true

# Image replacement for prod (Docker Hub)
images:
- name: jretirewise
  newName: jaysuzi5/jretirewise
  newTag: latest

commonLabels:
  environment: production

namePrefix: prod-

# Production patches for higher resources
patchesStrategicMerge:
- deployment-web-patch.yaml
- statefulset-postgres-patch.yaml

# Network policies for prod - soft anti-affinity (preferred, not required)
# Pods can run on same node if needed due to resource constraints
patchesJson6902: []

commonAnnotations:
  environment: production
  kustomize.config.k8s.io/version: "5.0.0"
  backup.velero.io/backup: "true"
